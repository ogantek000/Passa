<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keepy - Keep Going</title>
<link rel="icon" href="icon.png">
<style>
body {
  font-family: system-ui, -apple-system, sans-serif;
  background: #0f172a;
  color: white;
  margin: 0;
  padding: 16px;
}
.header {
  text-align: center;
  margin-bottom: 24px;
}
.mascot {
  width: 200px;
  height: 200px;
  margin: 0 auto 12px;
  display: block;
  border-radius: 50%;
  object-fit: cover;
}
h1 { 
  margin: 8px 0 4px 0;
  font-size: 36px;
}
.motto {
  font-size: 16px;
  color: #94a3b8;
  margin: 0 0 12px 0;
}
h2 {
  font-size: 22px;
  margin: 16px 0;
}
.add {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #22c55e;
  color: black;
  font-size: 32px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
.habit {
  background: #020617;
  padding: 16px;
  border-radius: 14px;
  margin-bottom: 12px;
  display: flex;
  flex-direction: column;
  transition: all 0.3s ease;
}
.habit.flash { animation: flash 0.5s; }
@keyframes flash {0% {background:#020617;}50% {background:#22c55e;}100% {background:#020617;}}
.habit.fade-out { animation: fadeOut 0.5s forwards; }
@keyframes fadeOut { to {opacity:0; transform: scale(0.8);} }

.habit-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.name { font-size: 18px; cursor: pointer; }
.streak { font-size: 22px; }
.actions button {
  margin-left: 6px;
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  cursor: pointer;
}
.done { background: #22c55e; }
.delete { background: #ef4444; color: white; }
.freeze { background: #facc15; color: black; }
.toggle-cal {
  background: #3b82f6;
  color: white;
  margin-top: 8px;
  width: 100%;
  padding: 8px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
}
.progress-container {
  background: #1e293b;
  border-radius: 4px;
  height: 8px;
  margin-top: 8px;
}
.progress {
  height: 8px;
  background: #22c55e;
  border-radius: 4px;
  width: 0%;
  transition: width 0.3s;
}
.calendar-container { margin-top: 8px; }
.calendar { display: flex; flex-wrap: wrap; overflow: hidden; max-height: 0; transition: max-height 0.3s ease; }
.calendar.show { max-height: 400px; overflow: visible; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.calendar-header button {
  background: #1e293b;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 12px;
  cursor: pointer;
}
.day {
  width: 14.2%;
  height: 24px;
  margin-bottom: 2px;
  text-align: center;
  line-height: 24px;
  font-size: 12px;
  border-radius: 4px;
  background: #111827;
  cursor: pointer;
}
.day.done { background: #22c55e; color: black; }
.day.freeze { background: #facc15; color: black; }
.day.missed { background: #ef4444; color: white; }
#stats {
  margin-bottom:16px;
  display:flex;
  justify-content:space-around;
  text-align:center;
}
#stats div { flex:1; }
#stats div div:first-child { font-size:18px; color:#94a3b8; }
#stats div div:last-child { font-size:22px; font-weight:bold; }
</style>
</head>
<body>

<div class="header">
  <img src="bro" class="mascot" id="mascot" alt="Keepy Mascot">
  <h1>Keepy</h1>
  <p class="motto">Keep Going</p>
  <h2>üî• Moje passy</h2>
</div>

<div id="stats">
  <div>
    <div>Dni wykonane</div>
    <div id="totalDone">0</div>
  </div>
  <div>
    <div>Najd≈Çu≈ºsza passa</div>
    <div id="maxStreak">0</div>
  </div>
  <div>
    <div>≈örednia dzienna</div>
    <div id="averageDaily">0</div>
  </div>
</div>

<div id="list"></div>
<button class="add" id="addBtn">+</button>

<script>
const list = document.getElementById("list");
const addBtn = document.getElementById("addBtn");
const today = () => new Date().toISOString().slice(0,10);
const yesterday = () => {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return d.toISOString().slice(0,10);
};

let habits = JSON.parse(localStorage.getItem("keepy-habits")) || [];
let archive = JSON.parse(localStorage.getItem("keepy-archive")) || [];

function save(){ 
  localStorage.setItem("keepy-habits", JSON.stringify(habits));
  localStorage.setItem("keepy-archive", JSON.stringify(archive));
}

function daysBetween(a,b){ return Math.floor((new Date(a)-new Date(b))/86400000); }
function wasYesterdayValid(h){ return (h.datesDone && h.datesDone.includes(yesterday())) || (h.freezeDates && h.freezeDates.includes(yesterday())); }

function updateStats(){
  let totalDone = 0;
  let maxStreak = 0;
  let totalDaysTracked = 0;

  habits.forEach(h => {
    if(h.datesDone) totalDone += h.datesDone.length;
    if(h.streak > maxStreak) maxStreak = h.streak;
    if(h.lastDate){
      const firstDate = h.datesDone && h.datesDone.length ? h.datesDone[0] : today();
      totalDaysTracked += daysBetween(today(), firstDate) + 1;
    }
  });

  const averageDaily = totalDaysTracked ? (totalDone / totalDaysTracked).toFixed(2) : 0;

  document.getElementById("totalDone").textContent = totalDone;
  document.getElementById("maxStreak").textContent = maxStreak;
  document.getElementById("averageDaily").textContent = averageDaily;
}

function renderCalendar(h, monthOffset=0){
  const container = document.createElement("div");
  container.className = "calendar-container";

  const calHeader = document.createElement("div");
  calHeader.className = "calendar-header";

  const left = document.createElement("button"); left.textContent="<";
  const right = document.createElement("button"); right.textContent=">";
  const title = document.createElement("span");

  let refDate = new Date();
  refDate.setMonth(refDate.getMonth()+monthOffset);
  title.textContent = refDate.toLocaleString('pl-PL',{month:'long', year:'numeric'});

  calHeader.appendChild(left);
  calHeader.appendChild(title);
  calHeader.appendChild(right);
  container.appendChild(calHeader);

  const calDiv = document.createElement("div");
  calDiv.className = "calendar";

  const firstDay = (new Date(refDate.getFullYear(), refDate.getMonth(),1).getDay()+6)%7;
  const daysInMonth = new Date(refDate.getFullYear(), refDate.getMonth()+1,0).getDate();

  for(let i=0;i<firstDay;i++){ 
    const empty = document.createElement("div"); 
    empty.className="day"; 
    calDiv.appendChild(empty); 
  }

  for(let d=1; d<=daysInMonth; d++){
    const dayStr = `${refDate.getFullYear()}-${String(refDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayDiv = document.createElement("div");
    dayDiv.className="day"; dayDiv.textContent=d;

    const isDone = h.datesDone && h.datesDone.includes(dayStr);
    const isFreeze = h.freezeDates && h.freezeDates.includes(dayStr) && !isDone;
    let isMissed = false;

    if(!isDone && !isFreeze){
      const allValid = [...(h.datesDone||[]),...(h.freezeDates||[])].sort();
      if(allValid.length>0){
        const latest = allValid[allValid.length-1];
        if(new Date(dayStr)<new Date(latest) && new Date(dayStr)<new Date()) isMissed=true;
      }
    }

    if(isDone) dayDiv.classList.add("done");
    else if(isFreeze) dayDiv.classList.add("freeze");
    else if(isMissed) dayDiv.classList.add("missed");

    dayDiv.onclick = () => {
      if(isDone) {
        h.datesDone = h.datesDone.filter(d => d!==dayStr);
        h.streak--;
      } else {
        if(!h.datesDone) h.datesDone=[];
        h.datesDone.push(dayStr);
        h.streak = Math.max(h.streak,1);
      }
      h.lastDate=today();
      save(); render();
    }

    calDiv.appendChild(dayDiv);
  }

  container.appendChild(calDiv);
  container.monthOffset = monthOffset;

  left.onclick = ()=>{ renderCalendarAndReplace(h, container, -1); };
  right.onclick = ()=>{ renderCalendarAndReplace(h, container, +1); };

  return container;
}

function renderCalendarAndReplace(habit, oldContainer, offset){
  const newCal = renderCalendar(habit, oldContainer.monthOffset+offset);
  oldContainer.replaceWith(newCal);
}

function notifyIfNotDone(h){
  if(Notification.permission==="granted"){
    const doneToday = h.datesDone && h.datesDone.includes(today());
    if(!doneToday && !h.freeze){
      new Notification(`Nie zapomnij o "${h.name}" dzisiaj!`);
    }
  }
}

function render(){
  list.innerHTML="";
  habits.forEach((h,i)=>{
    if(!h.freeze && h.lastDate){
      const diff = daysBetween(today(), h.lastDate);
      if(diff>=2){
        let allDaysCovered = true;
        for(let d=1; d<diff; d++){
          const checkStr = new Date(h.lastDate); checkStr.setDate(checkStr.getDate()+d); checkStr = checkStr.toISOString().slice(0,10);
          if(!(h.datesDone && h.datesDone.includes(checkStr)) && !(h.freezeDates && h.freezeDates.includes(checkStr))){
            allDaysCovered=false; break;
          }
        }
        if(!allDaysCovered) h.streak=0;
      }
    }

    const div=document.createElement("div"); div.className="habit";

    const doneToday = h.datesDone && h.datesDone.includes(today());
    const freeze = h.freeze===true;

    div.innerHTML = `
      <div class="habit-header">
        <div>
          <div class="name">${h.name}</div>
          <div class="streak">üî• ${h.streak}</div>
        </div>
        <div class="actions">
          <button class="done" ${doneToday||freeze?"disabled":""}>
            ${doneToday ? "Zrobione ‚úîÔ∏è" : "Zrobione dzi≈õ"}
          </button>
          <button class="freeze">${freeze ? "‚è∏Ô∏è" : "Freeze"}</button>
          <button class="delete">‚úï</button>
        </div>
      </div>
      <div class="progress-container">
        <div class="progress" style="width:${Math.min((h.streak/30)*100,100)}%"></div>
      </div>
    `;

    const toggleBtn = document.createElement("button");
    toggleBtn.className = "toggle-cal";
    toggleBtn.textContent = "üìÖ Poka≈º kalendarz";
    div.appendChild(toggleBtn);

    let calendarDiv = renderCalendar(h,0);
    div.appendChild(calendarDiv);

    toggleBtn.onclick=()=> {
      const cal = calendarDiv.querySelector(".calendar");
      cal.classList.toggle("show");
      toggleBtn.textContent = cal.classList.contains("show") ? "üìÖ Ukryj kalendarz" : "üìÖ Poka≈º kalendarz";
    };

    div.querySelector(".done").onclick=()=>{
      if(freeze || doneToday) return;
      if(!confirm(`Czy na pewno chcesz oznaczyƒá "${h.name}" jako zrobione?`)) return;

      if(!h.datesDone) h.datesDone=[];
      h.datesDone.push(today());
      h.streak = wasYesterdayValid(h) ? h.streak+1 : 1;
      h.lastDate=today();
      save();
      div.classList.add("flash");
      setTimeout(()=>div.classList.remove("flash"),500);
      render();
    };

    div.querySelector(".delete").onclick=()=>{
      if(!confirm(`Czy na pewno chcesz usunƒÖƒá passƒô "${h.name}"?`)) return;
      div.classList.add("fade-out");
      setTimeout(()=>{
        archive.push(h);
        habits.splice(i,1);
        save();
        render();
      },500);
    };

    div.querySelector(".freeze").onclick=()=>{
      if(!confirm(`Czy na pewno chcesz ${freeze ? "odmroziƒá" : "zamroziƒá"} passƒô "${h.name}"?`)) return;
      h.freeze = !h.freeze;
      if(!h.freezeDates) h.freezeDates=[];
      if(h.freeze) h.freezeDates.push(today());
      if(!h.lastDate || new Date(today())>new Date(h.lastDate)) h.lastDate=today();
      save();
      render();
    };

    list.appendChild(div);

    notifyIfNotDone(h);
  });

  updateStats();
}

addBtn.onclick=()=>{
  const name=prompt("Nazwa nowej passy:");
  if(!name) return;
  habits.push({name, streak:0, lastDate:null, datesDone:[], freeze:false, freezeDates:[]});
  save();
  render();
};

if(Notification.permission !== "granted"){
  Notification.requestPermission();
}

render();
</script>

</body>
</html>
