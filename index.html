<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Keepy â€“ Keep Going</title>
<link rel="icon" href="icon.png">

<style>
:root {
  --bg-primary: #0f172a;
  --bg-secondary: rgba(255,255,255,0.05);
  --bg-tertiary: #1e293b;
  --text-primary: white;
  --text-secondary: #94a3b8;
  --accent: #3b82f6;
  --success: #22c55e;
  --warning: #facc15;
  --danger: #ef4444;
}

* {
  -webkit-overflow-scrolling: touch;
}

html {
  scroll-behavior: auto;
}

[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: rgba(0,0,0,0.05);
  --bg-tertiary: #e2e8f0;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
}

[data-theme="ocean"] {
  --bg-primary: #0a192f;
  --bg-secondary: rgba(100,255,218,0.08);
  --bg-tertiary: #172a45;
  --accent: #64ffda;
  --text-primary: #ccd6f6;
  --text-secondary: #8892b0;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  margin:0;padding:16px;
  padding-bottom:max(24px,env(safe-area-inset-bottom));
  transition:background .3s, color .3s;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  -webkit-tap-highlight-color:transparent;
  overscroll-behavior:none;
  -webkit-user-select:none;
  -moz-user-select:none;
  -ms-user-select:none;
  user-select:none;
}

input, textarea, [contenteditable]{
  -webkit-user-select:text;
  -moz-user-select:text;
  -ms-user-select:text;
  user-select:text;
}

.header{text-align:center;margin-bottom:10px;position:relative}
.theme-toggle{
  position:absolute;top:0;right:0;
  background:var(--bg-tertiary);border:none;
  padding:12px 16px;border-radius:10px;cursor:pointer;
  color:var(--text-primary);font-size:20px;
  min-width:44px;min-height:44px;
  transition:transform .2s, opacity .2s;
}
.theme-toggle:active{
  transform:scale(0.95);
  opacity:0.8;
}
.mascot{width:200px;height:200px;border-radius:50%;object-fit:cover}
h1{margin:6px 0 2px;color:var(--accent)}
.motto{color:var(--text-secondary);font-size:14px}
#countdown{font-size:16px;font-weight:600;color:var(--text-secondary);margin:6px 0 14px}

#stats{
  display:flex;justify-content:space-around;
  background:var(--bg-secondary);
  padding:12px;border-radius:14px;margin-bottom:14px;
}
#stats div{text-align:center}
#stats div div:first-child{font-size:13px;color:var(--text-secondary)}
#stats div div:last-child{font-size:18px;font-weight:bold;color:var(--accent)}

.charts{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:14px;
}
.charts h3{margin:0 0 12px;font-size:16px;color:var(--text-secondary)}
.heat-map{
  display:grid;grid-template-columns:repeat(7,1fr);
  gap:3px;margin-bottom:16px;
}
.heat-day{
  aspect-ratio:1;border-radius:3px;
  background:var(--bg-tertiary);
  font-size:9px;
  display:flex;align-items:center;justify-content:center;
  color:var(--text-secondary);
  position:relative;
}
.heat-day:hover{
  transform:scale(1.1);
  z-index:1;
  cursor:pointer;
}
.heat-day.level-1{background:#16a34a;opacity:0.3;color:white}
.heat-day.level-2{background:#16a34a;opacity:0.6;color:white}
.heat-day.level-3{background:#16a34a;opacity:0.9;color:white}
.heat-day.level-4{background:#16a34a;color:white}

.habit{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:12px;
  opacity:0;transform:translateY(20px);
  transition:all .4s cubic-bezier(0.34, 1.56, 0.64, 1);
  position:relative;
  border-left:4px solid transparent;
  scroll-margin-top:20px;
  overflow:visible;
  z-index:1;
}
.habit.show{opacity:1;transform:none}
.habit.dragging{opacity:0.5;transform:scale(0.98)}
.habit.menu-open{z-index:200}

.habit.ice::after{
  content:"";position:absolute;inset:0;
  background:var(--accent);opacity:0;border-radius:14px;
  animation:ice .8s
}
@keyframes ice{30%,60%{opacity:.6}100%{opacity:0}}

.category-badge{
  display:inline-block;
  padding:4px 12px;border-radius:12px;
  font-size:12px;font-weight:600;
  margin-bottom:8px;
}
.cat-sport{background:#3b82f6;color:white}
.cat-health{background:#22c55e;color:white}
.cat-work{background:#f59e0b;color:white}
.cat-study{background:#8b5cf6;color:white}
.cat-hobby{background:#ec4899;color:white}
.cat-other{background:#6b7280;color:white}

.habit-header{
  display:flex;flex-direction:column;gap:12px
}
.habit-info{
  display:flex;justify-content:space-between;align-items:center
}
.name{font-size:18px;font-weight:600}
.streak{font-size:20px;color:#ff9500}

.actions{display:flex;gap:6px;flex-wrap:wrap}
.actions button{
  padding:8px 12px;border:none;border-radius:8px;cursor:pointer;
  font-size:13px;
  min-height:38px;
  font-weight:500;
  transition:transform .2s, opacity .2s;
  flex:1;
  min-width:90px;
}
.actions button:active{
  transform:scale(0.95);
  opacity:0.8;
}
.done{background:var(--success);color:white}
.freeze{background:var(--warning);color:black}
.more{background:var(--bg-tertiary);color:var(--text-primary);font-size:18px;min-width:38px;flex:0}

.menu{
  position:absolute;right:12px;top:52px;
  background:var(--bg-primary);border-radius:10px;
  overflow:hidden;display:none;
  box-shadow:0 10px 30px rgba(0,0,0,.5);z-index:100;
  border:1px solid var(--bg-tertiary);
}
.menu button{
  width:100%;padding:14px 16px;
  background:none;border:none;color:var(--text-primary);
  text-align:left;cursor:pointer;
  font-size:15px;
  min-height:48px;
  transition:background .2s;
}
.menu button:hover{background:var(--bg-secondary)}
.menu button:active{background:var(--bg-tertiary)}

.toggle-cal{
  width:100%;margin-top:8px;
  padding:12px;border:none;border-radius:10px;
  background:var(--accent);color:white;cursor:pointer;
  font-weight:500;font-size:15px;
  min-height:44px;
  transition:transform .2s, opacity .2s;
}
.toggle-cal:active{
  transform:scale(0.98);
  opacity:0.9;
}

.calendar-container{margin-top:8px;position:relative;overflow:hidden}
.calendar{
  overflow:hidden;
  transition:all .3s ease;
  pointer-events:none;
  opacity:0;
  max-height:0;
}
.calendar.show{
  opacity:1;
  pointer-events:auto;
  max-height:500px;
}

.calendar.editing{
  outline:2px dashed #f97316
}

.calendar-nav{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:8px;
  gap:12px;
}
.calendar-nav span{
  color:var(--text-primary);font-weight:bold;
  flex:1;text-align:center;
}
.calendar-nav button{
  background:var(--bg-tertiary);color:var(--text-primary);border:none;padding:6px 12px;border-radius:4px;
  cursor:pointer;flex-shrink:0;
}

.calendar-days{
  display:flex;flex-wrap:wrap;
}

.day{
  width:14.2%;height:32px;
  line-height:32px;text-align:center;
  font-size:12px;border-radius:6px;
  background:var(--bg-tertiary);
  transition:transform .2s;
}
.calendar.editing .day{cursor:pointer}
.calendar.editing .day:active{
  transform:scale(0.9);
}

.day.done{background:var(--success);color:white}
.day.freeze{background:var(--warning);color:black}
.day.missed{background:var(--danger);color:white}
.day.locked{opacity:.35}

.add{
  position:fixed;bottom:max(24px,env(safe-area-inset-bottom));right:24px;
  width:60px;height:60px;border-radius:50%;
  background:var(--success);color:white;font-size:32px;border:none;cursor:pointer;
  box-shadow:0 4px 20px rgba(34,197,94,0.4);
  transition:transform .3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow .3s;
  z-index:10;
}
.add:active{
  transform:scale(0.9);
  box-shadow:0 2px 10px rgba(34,197,94,0.3);
}

.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,0.7);z-index:100;
  align-items:center;justify-content:center;
  animation:fadeIn .3s ease;
}
.modal.show{display:flex}
@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}
.modal-content{
  background:var(--bg-primary);
  padding:24px;border-radius:16px;
  max-width:400px;width:90%;
  border:1px solid var(--bg-tertiary);
  animation:slideUp .4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes slideUp{
  from{transform:translateY(50px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
.modal h3{margin:0 0 16px;color:var(--accent)}
.modal input, .modal select{
  width:100%;padding:10px;margin-bottom:12px;
  border:1px solid var(--bg-tertiary);
  border-radius:8px;background:var(--bg-secondary);
  color:var(--text-primary);
  box-sizing:border-box;
}
.modal-buttons{
  display:flex;gap:8px;justify-content:flex-end;
}
.modal-buttons button{
  padding:12px 20px;border:none;border-radius:10px;cursor:pointer;
  font-size:16px;font-weight:500;
  min-height:44px;min-width:80px;
  transition:transform .2s, opacity .2s;
}
.modal-buttons button:active{
  transform:scale(0.95);
  opacity:0.8;
}
.btn-primary{background:var(--accent);color:white}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary)}

.quote-box{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:14px;
  position:relative;
  border-left:4px solid var(--accent);
}
.quote-text{
  font-style:italic;color:var(--text-primary);
  font-size:15px;line-height:1.5;
  padding-right:40px;
}
.quote-refresh{
  position:absolute;right:12px;top:12px;
  background:var(--bg-tertiary);border:none;
  width:36px;height:36px;border-radius:50%;
  font-size:16px;cursor:pointer;
  transition:transform .3s;
}
.quote-refresh:active{
  transform:rotate(180deg);
}

.empty-state{
  text-align:center;
  padding:60px 20px;
  background:var(--bg-secondary);
  border-radius:14px;
  margin:20px 0;
}

.category-stats{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:14px;
}
.category-stat-item{
  display:flex;justify-content:space-between;
  padding:8px 0;border-bottom:1px solid var(--bg-tertiary);
}
.category-stat-item:last-child{border:none}

.toast{
  position:fixed;bottom:100px;left:50%;
  transform:translateX(-50%) translateY(100px);
  background:var(--bg-primary);
  padding:16px 20px;border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.5);
  border:1px solid var(--bg-tertiary);
  display:flex;gap:12px;align-items:center;
  z-index:200;
  opacity:0;
  transition:all .3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.toast.show{
  transform:translateX(-50%) translateY(0);
  opacity:1;
}
.toast button{
  background:var(--accent);color:white;
  border:none;padding:8px 16px;border-radius:8px;
  cursor:pointer;font-weight:500;
}

.loading-skeleton{
  background:linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
  background-size:200% 100%;
  animation:shimmer 1.5s infinite;
  border-radius:14px;
  height:120px;
  margin-bottom:12px;
}
@keyframes shimmer{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}

.streak-bounce{
  animation:bounce .5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes bounce{
  0%, 100%{transform:scale(1)}
  50%{transform:scale(1.3)}
}
</style>
</head>
<body>

<div class="header">
  <button class="theme-toggle" id="themeBtn">ğŸŒ™</button>
  <img src="bro" class="mascot">
  <h1>Keepy</h1>
  <p class="motto">Keep Going</p>
  <div id="countdown">--:--:--</div>
</div>

<div id="stats">
  <div><div>Dni wykonane</div><div id="totalDone">0</div></div>
  <div><div>NajdÅ‚uÅ¼sza passa</div><div id="maxStreak">0</div></div>
  <div><div>Åšrednia dzienna</div><div id="avgDaily">0</div></div>
</div>

<div class="quote-box" id="quoteBox" data-section="quote" draggable="true">
  <div class="drag-section-handle" style="cursor:move;text-align:center;color:var(--text-secondary);font-size:16px;margin-bottom:8px">â‹®â‹®</div>
  <div class="quote-text" id="quoteText"></div>
  <div style="position:absolute;right:12px;top:12px;display:flex;gap:6px">
    <button class="lang-flag" data-lang="pl" style="background:none;border:none;font-size:20px;cursor:pointer;opacity:0.5;transition:opacity .2s">ğŸ‡µğŸ‡±</button>
    <button class="lang-flag" data-lang="en" style="background:none;border:none;font-size:20px;cursor:pointer;opacity:0.5;transition:opacity .2s">ğŸ‡¬ğŸ‡§</button>
    <button class="lang-flag" data-lang="es" style="background:none;border:none;font-size:20px;cursor:pointer;opacity:0.5;transition:opacity .2s">ğŸ‡ªğŸ‡¸</button>
    <button class="quote-refresh" id="quoteRefresh" style="background:var(--bg-tertiary);border:none;width:36px;height:36px;border-radius:50%;font-size:16px;cursor:pointer;transition:transform .3s">ğŸ”„</button>
  </div>
</div>

<div class="charts" data-section="heatmap" draggable="true">
  <div class="drag-section-handle" style="cursor:move;text-align:center;color:var(--text-secondary);font-size:16px;margin-bottom:8px">â‹®â‹®</div>
  <h3 style="font-size:16px;color:var(--text-secondary);margin:0 0 8px;cursor:pointer" id="heatMapToggle">
    ğŸ“Š AktywnoÅ›Ä‡ (ostatnie 28 dni) <span style="float:right">â–¼</span>
  </h3>
  <div id="heatMapContainer">
    <p style="font-size:13px;color:var(--text-secondary);margin:0 0 12px">KaÅ¼dy kwadrat to jeden dzieÅ„. Im ciemniejszy kolor, tym wiÄ™cej pass zrobiÅ‚eÅ› tego dnia.</p>
    <div class="heat-map" id="heatMap"></div>
  </div>
</div>

<div class="category-stats" id="categoryStats" style="display:none" data-section="categories" draggable="true">
  <div class="drag-section-handle" style="cursor:move;text-align:center;color:var(--text-secondary);font-size:16px;margin-bottom:8px">â‹®â‹®</div>
  <h3 style="font-size:16px;color:var(--text-secondary);margin:0 0 12px;cursor:pointer" id="categoryStatsToggle">
    ğŸ“ˆ Statystyki per kategoria <span style="float:right">â–¼</span>
  </h3>
  <div style="display:none;margin-bottom:8px" id="categorySortButtons">
    <button class="btn-secondary" id="sortByName" style="padding:6px 12px;margin-right:6px;font-size:13px">Sortuj: Nazwa</button>
    <button class="btn-secondary" id="sortByDays" style="padding:6px 12px;font-size:13px">Sortuj: Dni</button>
  </div>
  <div id="categoryStatsList" style="display:none"></div>
</div>

<div class="empty-state" id="emptyState" style="display:none">
  <div style="font-size:60px;margin-bottom:16px">ğŸ’ª</div>
  <h2 style="color:var(--accent);margin:0 0 8px">Zacznij swojÄ… przygodÄ™!</h2>
  <p style="color:var(--text-secondary);margin:0">Dodaj swojÄ… pierwszÄ… passÄ™ i buduj nawyki kaÅ¼dego dnia</p>
</div>

<div id="list"></div>
<button class="add" id="addBtn">+</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>â• Dodaj nowÄ… passÄ™</h3>
    <input type="text" id="habitName" placeholder="Nazwa passy">
    <select id="habitCategory">
      <option value="sport">ğŸƒ Sport</option>
      <option value="health">ğŸ’š Zdrowie</option>
      <option value="work">ğŸ’¼ Praca</option>
      <option value="study">ğŸ“š Nauka</option>
      <option value="hobby">ğŸ¨ Hobby</option>
      <option value="other">âšª Inne</option>
      <option value="custom">â• WÅ‚asna kategoria...</option>
    </select>
    <input type="text" id="customCategory" placeholder="Wpisz nazwÄ™ wÅ‚asnej kategorii" style="display:none">
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelBtn">Anuluj</button>
      <button class="btn-primary" id="saveBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="modal" id="editCategoryModal">
  <div class="modal-content">
    <h3>ğŸ·ï¸ ZmieÅ„ kategoriÄ™</h3>
    <select id="editCategorySelect">
      <option value="sport">ğŸƒ Sport</option>
      <option value="health">ğŸ’š Zdrowie</option>
      <option value="work">ğŸ’¼ Praca</option>
      <option value="study">ğŸ“š Nauka</option>
      <option value="hobby">ğŸ¨ Hobby</option>
      <option value="other">âšª Inne</option>
      <option value="custom">â• WÅ‚asna kategoria...</option>
    </select>
    <input type="text" id="editCustomCategory" placeholder="Wpisz nazwÄ™ wÅ‚asnej kategorii" style="display:none">
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelEditCatBtn">Anuluj</button>
      <button class="btn-primary" id="saveEditCatBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="modal" id="streakEmojiModal">
  <div class="modal-content">
    <h3>ğŸ”¥ Personalizuj emoji passy</h3>
    <input type="text" id="streakEmoji" placeholder="np. ğŸ”¥, ğŸš€, â­, ğŸ’" maxlength="2">
    <p style="font-size:13px;color:var(--text-secondary);margin:8px 0">Wpisz swoje ulubione emoji (lub zostaw puste dla domyÅ›lnego ğŸ”¥)</p>
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelStreakEmojiBtn">Anuluj</button>
      <button class="btn-primary" id="saveStreakEmojiBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="modal" id="manageQuotesModal">
  <div class="modal-content">
    <h3>ğŸ’­ ZarzÄ…dzaj cytatami</h3>
    <label style="font-size:14px;color:var(--text-secondary);display:block;margin-bottom:8px">JÄ™zyk domyÅ›lnych cytatÃ³w:</label>
    <select id="quoteLanguage" style="width:100%;padding:10px;margin-bottom:12px;border:1px solid var(--bg-tertiary);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box">
      <option value="pl">ğŸ‡µğŸ‡± Polski</option>
      <option value="en">ğŸ‡¬ğŸ‡§ Angielski</option>
      <option value="es">ğŸ‡ªğŸ‡¸ HiszpaÅ„ski</option>
    </select>
    <label style="font-size:14px;color:var(--text-secondary);display:block;margin-bottom:8px">WÅ‚asne cytaty:</label>
    <textarea id="customQuotes" placeholder="Wpisz wÅ‚asne cytaty (kaÅ¼dy w nowej linii)" rows="8" style="width:100%;padding:10px;border:1px solid var(--bg-tertiary);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box;font-family:inherit;margin-bottom:8px"></textarea>
    <p style="font-size:13px;color:var(--text-secondary);margin:8px 0">DomyÅ›lne cytaty w wybranym jÄ™zyku + Twoje wÅ‚asne bÄ™dÄ… losowo wyÅ›wietlane</p>
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelQuotesBtn">Anuluj</button>
      <button class="btn-primary" id="saveQuotesBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <span id="toastText"></span>
  <button id="toastAction" style="display:none"></button>
</div>

<script>
const DAY=86400000;
const list=document.getElementById("list");
const themes=['dark','light','ocean'];
let currentTheme=0;
let deletedHabit=null;
let deletedIndex=null;

const defaultQuotes=[
  {
    pl: "Sukces to suma maÅ‚ych wysiÅ‚kÃ³w powtarzanych dzieÅ„ po dniu.",
    en: "Success is the sum of small efforts repeated day after day.",
    es: "El Ã©xito es la suma de pequeÃ±os esfuerzos repetidos dÃ­a tras dÃ­a."
  },
  {
    pl: "Nie liczy siÄ™ perfekcja, liczy siÄ™ konsekwencja.",
    en: "It's not about perfection, it's about consistency.",
    es: "No se trata de perfecciÃ³n, se trata de consistencia."
  },
  {
    pl: "KaÅ¼dy dzieÅ„ to nowa szansa na bycie lepszÄ… wersjÄ… siebie.",
    en: "Every day is a new chance to be a better version of yourself.",
    es: "Cada dÃ­a es una nueva oportunidad para ser mejor."
  },
  {
    pl: "Nawyki budujÄ… przyszÅ‚oÅ›Ä‡, ktÃ³rÄ… sobie wymarzyÅ‚eÅ›.",
    en: "Habits build the future you dreamed of.",
    es: "Los hÃ¡bitos construyen el futuro que soÃ±aste."
  },
  {
    pl: "MaÅ‚a zmiana dziÅ› = wielka rÃ³Å¼nica jutro.",
    en: "Small change today = big difference tomorrow.",
    es: "PequeÃ±o cambio hoy = gran diferencia maÃ±ana."
  },
  {
    pl: "Nie rezygnuj! JesteÅ› bliÅ¼ej niÅ¼ myÅ›lisz.",
    en: "Don't give up! You're closer than you think.",
    es: "Â¡No te rindas! EstÃ¡s mÃ¡s cerca de lo que crees."
  },
  {
    pl: "Twoja przyszÅ‚oÅ›Ä‡ jest tworzona przez to, co robisz dzisiaj.",
    en: "Your future is created by what you do today.",
    es: "Tu futuro se crea por lo que haces hoy."
  },
  {
    pl: "Motywacja CiÄ™ uruchamia. Nawyk CiÄ™ prowadzi.",
    en: "Motivation gets you started. Habit keeps you going.",
    es: "La motivaciÃ³n te pone en marcha. El hÃ¡bito te mantiene."
  },
  {
    pl: "BÄ…dÅº silniejszy niÅ¼ twoje wymÃ³wki.",
    en: "Be stronger than your excuses.",
    es: "SÃ© mÃ¡s fuerte que tus excusas."
  },
  {
    pl: "Dzisiaj jest dobry dzieÅ„, Å¼eby byÄ‡ produktywnym!",
    en: "Today is a good day to be productive!",
    es: "Â¡Hoy es un buen dÃ­a para ser productivo!"
  }
];

let currentQuoteIndex=0;
let currentQuoteLang='pl';

function showToast(text,actionText,actionCallback){
  const toast=document.getElementById("toast");
  const toastText=document.getElementById("toastText");
  const toastAction=document.getElementById("toastAction");
  
  toastText.textContent=text;
  if(actionText){
    toastAction.textContent=actionText;
    toastAction.style.display='block';
    toastAction.onclick=()=>{
      actionCallback();
      toast.classList.remove("show");
    };
  }else{
    toastAction.style.display='none';
  }
  
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),4000);
}

function getRandomQuote(){
  currentQuoteIndex=Math.floor(Math.random()*defaultQuotes.length);
  return defaultQuotes[currentQuoteIndex][currentQuoteLang];
}

function updateQuote(){
  const quote=getRandomQuote();
  document.getElementById("quoteText").textContent=quote;
  updateLangFlags();
}

function updateLangFlags(){
  document.querySelectorAll('.lang-flag').forEach(btn=>{
    if(btn.dataset.lang===currentQuoteLang){
      btn.style.opacity='1';
      btn.style.transform='scale(1.1)';
    }else{
      btn.style.opacity='0.5';
      btn.style.transform='scale(1)';
    }
  });
}

function switchQuoteLang(lang){
  currentQuoteLang=lang;
  localStorage.setItem('quoteLang',lang);
  document.getElementById("quoteText").textContent=defaultQuotes[currentQuoteIndex][lang];
  updateLangFlags();
}

function today(){
  const d=new Date();
  d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  return d.toISOString().slice(0,10);
}

function startCountdown(){
  const el=document.getElementById("countdown");
  setInterval(()=>{
    const now=new Date();
    const midnight=new Date();
    midnight.setHours(24,0,0,0);
    const diff=midnight-now;
    const h=String(Math.floor(diff/3600000)).padStart(2,"0");
    const m=String(Math.floor(diff%3600000/60000)).padStart(2,"0");
    const s=String(Math.floor(diff%60000/1000)).padStart(2,"0");
    el.textContent=`${h}:${m}:${s}`;
  },1000);
}
startCountdown();

let habits=JSON.parse(localStorage.getItem("keepy"))||[];
const save=()=>localStorage.setItem("keepy",JSON.stringify(habits));

// Theme toggle
document.getElementById("themeBtn").onclick=()=>{
  currentTheme=(currentTheme+1)%themes.length;
  document.body.setAttribute('data-theme',themes[currentTheme]);
  document.getElementById("themeBtn").textContent=themes[currentTheme]==='light'?'â˜€ï¸':themes[currentTheme]==='ocean'?'ğŸŒŠ':'ğŸŒ™';
  localStorage.setItem("theme",themes[currentTheme]);
};

const savedTheme=localStorage.getItem("theme");
if(savedTheme){
  currentTheme=themes.indexOf(savedTheme);
  document.body.setAttribute('data-theme',savedTheme);
  document.getElementById("themeBtn").textContent=savedTheme==='light'?'â˜€ï¸':savedTheme==='ocean'?'ğŸŒŠ':'ğŸŒ™';
}

function updateStats(){
  let total=0,max=0,dates={},categoryCount={};
  habits.forEach(h=>{
    h.datesDone.forEach(d=>{
      total++;dates[d]=(dates[d]||0)+1;
    });
    if(h.streak>max)max=h.streak;
    
    // Category stats
    const cat=h.category||'other';
    if(!categoryCount[cat])categoryCount[cat]={count:0,days:0};
    categoryCount[cat].count++;
    categoryCount[cat].days+=h.datesDone.length;
  });
  const days=Object.keys(dates).length||1;
  totalDone.textContent=total;
  maxStreak.textContent=max;
  avgDaily.textContent=(total/days).toFixed(2);
  
  // Category stats display
  const categoryStats=document.getElementById("categoryStats");
  const categoryStatsList=document.getElementById("categoryStatsList");
  const sortButtons=document.getElementById("categorySortButtons");
  
  window.categoryData=categoryCount; // Store for sorting
  
  if(Object.keys(categoryCount).length>0){
    categoryStats.style.display='block';
    renderCategoryStats('days'); // Default sort by days
  }
  
  // Heat map
  const heatMap=document.getElementById("heatMap");
  heatMap.innerHTML="";
  for(let i=27;i>=0;i--){
    const d=new Date();
    d.setDate(d.getDate()-i);
    const ds=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const count=dates[ds]||0;
    const div=document.createElement("div");
    div.className="heat-day";
    if(count>0)div.classList.add(`level-${Math.min(count,4)}`);
    
    const dayNum=d.getDate();
    div.textContent=dayNum;
    
    const monthName=d.toLocaleString("pl-PL",{month:'short'});
    div.title=`${dayNum} ${monthName}: ${count} pass${count===1?'a':count>=2&&count<=4?'y':''}`;
    
    heatMap.append(div);
  }
}

function renderCategoryStats(sortBy){
  const categoryStatsList=document.getElementById("categoryStatsList");
  if(!window.categoryData) return;
  
  let entries=Object.entries(window.categoryData);
  
  if(sortBy==='name'){
    entries.sort((a,b)=>getCategoryLabel(a[0]).localeCompare(getCategoryLabel(b[0])));
  }else{
    entries.sort((a,b)=>b[1].days-a[1].days);
  }
  
  categoryStatsList.innerHTML='';
  
  entries.forEach(([cat,data])=>{
    const div=document.createElement("div");
    div.className="category-stat-item";
    div.innerHTML=`
      <span>${getCategoryLabel(cat)}</span>
      <span style="color:var(--accent);font-weight:bold">${data.days} dni (${data.count} pass${data.count===1?'a':''})</span>
    `;
    categoryStatsList.append(div);
  });
}

function renderCalendar(h){
  const cont=document.createElement("div");
  cont.className="calendar-container";

  const cal=document.createElement("div");
  cal.className="calendar";
  if(h.calendarOpen) cal.classList.add("show");
  if(h.editing) cal.classList.add("editing");

  const ref=new Date();
  ref.setMonth(ref.getMonth()+h.monthOffset);
  
  const nav=document.createElement("div");
  nav.className="calendar-nav";
  const l=document.createElement("button");
  l.textContent="<";
  const r=document.createElement("button");
  r.textContent=">";
  const title=document.createElement("span");
  title.textContent=ref.toLocaleString("pl-PL",{month:"long",year:"numeric"});

  nav.append(l,title,r);
  cal.append(nav);

  l.onclick=(e)=>{e.stopPropagation(); h.monthOffset--; save(); render();}
  r.onclick=(e)=>{e.stopPropagation(); h.monthOffset++; save(); render();}

  const daysContainer=document.createElement("div");
  daysContainer.className="calendar-days";

  const first=(new Date(ref.getFullYear(),ref.getMonth(),1).getDay()+6)%7;
  const daysInMonth=new Date(ref.getFullYear(),ref.getMonth()+1,0).getDate();

  for(let i=0;i<first;i++) daysContainer.append(document.createElement("div"));
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(ref.getFullYear(),ref.getMonth(),d);
    const ds=new Date(date.getTime()-date.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const diff=(new Date(today())-new Date(ds))/DAY;
    const editable=diff>=0 && diff<=7;

    const div=document.createElement("div");
    div.className="day";
    div.textContent=d;

    if(h.datesDone.includes(ds)) div.classList.add("done");
    else if(h.freezeDates.includes(ds)) div.classList.add("freeze");
    else if(diff>0) div.classList.add("missed");
    if(!editable) div.classList.add("locked");

    div.onclick=()=>{
      if(!h.editing || !editable) return;
      if(h.datesDone.includes(ds))
        h.datesDone=h.datesDone.filter(x=>x!==ds);
      else
        h.datesDone.push(ds);
      save(); render();
    };

    daysContainer.append(div);
  }

  cal.append(daysContainer);
  cont.append(cal);
  return {cont,cal};
}

let draggedIndex=null;

function getCategoryLabel(category){
  const defaultLabels={
    sport:'ğŸƒ Sport',
    health:'ğŸ’š Zdrowie',
    work:'ğŸ’¼ Praca',
    study:'ğŸ“š Nauka',
    hobby:'ğŸ¨ Hobby',
    other:'âšª Inne'
  };
  return defaultLabels[category]||`â­ ${category}`;
}

function getCategoryColor(category){
  const defaultColors={
    sport:'#3b82f6',
    health:'#22c55e',
    work:'#f59e0b',
    study:'#8b5cf6',
    hobby:'#ec4899',
    other:'#6b7280'
  };
  return defaultColors[category]||'#10b981';
}

function render(){
  const emptyState=document.getElementById("emptyState");
  const categoryStats=document.getElementById("categoryStats");
  
  if(habits.length===0){
    list.innerHTML="";
    emptyState.style.display='block';
    categoryStats.style.display='none';
    updateStats();
    return;
  }
  
  emptyState.style.display='none';
  
  // Show loading skeletons
  list.innerHTML='<div class="loading-skeleton"></div><div class="loading-skeleton"></div>';
  
  setTimeout(()=>{
    list.innerHTML="";
    habits.forEach((h,i)=>{
      const div=document.createElement("div");
      div.className="habit";
      
      div.style.borderLeftColor=getCategoryColor(h.category||'other');
      
      const streakEmoji=h.streakEmoji||'ğŸ”¥';

      div.innerHTML=`
        <div class="drag-handle" draggable="true" style="cursor:move;padding:4px;margin:-16px -16px 8px -16px;background:var(--bg-tertiary);border-radius:14px 14px 0 0;text-align:center;color:var(--text-secondary);font-size:20px">â‹®â‹®</div>
        <span class="category-badge cat-${h.category||'other'}">${getCategoryLabel(h.category||'other')}</span>
        <div class="habit-header">
          <div class="habit-info">
            <div class="name">${h.name}</div>
            <div class="streak" id="streak-${i}">${streakEmoji} ${h.streak}</div>
          </div>
          <div class="actions">
            <button class="done">âœ“ Zrobione</button>
            <button class="freeze">${h.freeze?"â„ï¸ OdmrÃ³Åº":"â„ï¸ Freeze"}</button>
            <button class="more">â‹¯</button>
          </div>
        </div>
        <div class="menu">
          <button class="editHist">âœï¸ Edytuj historiÄ™</button>
          <button class="renameHabit">âœï¸ ZmieÅ„ nazwÄ™</button>
          <button class="changeCat">ğŸ·ï¸ ZmieÅ„ kategoriÄ™</button>
          <button class="changeEmoji">ğŸ”¥ ZmieÅ„ emoji</button>
          <button class="deleteHist">ğŸ—‘ UsuÅ„ passÄ™</button>
        </div>
      `;

    // Drag & drop - only from handle
    const handle=div.querySelector('.drag-handle');
    handle.ondragstart=(e)=>{
      draggedIndex=i;
      div.classList.add('dragging');
    };
    handle.ondragend=()=>{
      div.classList.remove('dragging');
    };
    div.ondragover=(e)=>{
      e.preventDefault();
    };
    div.ondrop=(e)=>{
      e.preventDefault();
      if(draggedIndex!==null && draggedIndex!==i){
        const temp=habits[draggedIndex];
        habits.splice(draggedIndex,1);
        habits.splice(i,0,temp);
        save();
        render();
      }
    };

    const menu=div.querySelector(".menu");
    const moreBtn=div.querySelector(".more");
    
    moreBtn.onclick=(e)=>{
      e.stopPropagation();
      document.querySelectorAll('.menu').forEach(m=>m.style.display='none');
      document.querySelectorAll('.habit').forEach(h=>h.classList.remove('menu-open'));
      menu.style.display=menu.style.display==="block"?"none":"block";
      if(menu.style.display==="block"){
        div.classList.add('menu-open');
      }
    };

    const toggle=document.createElement("button");
    toggle.className="toggle-cal";
    toggle.textContent=h.calendarOpen?"ğŸ“… Ukryj kalendarz":"ğŸ“… PokaÅ¼ kalendarz";

    const {cont,cal}=renderCalendar(h);

    toggle.onclick=()=>{h.calendarOpen=!h.calendarOpen; save(); render();};

    div.querySelector(".editHist").onclick=()=>{h.editing=!h.editing; menu.style.display="none"; save(); render();};
    div.querySelector(".renameHabit").onclick=()=>{
      menu.style.display="none";
      const newName=prompt("Nowa nazwa passy:",h.name);
      if(newName && newName.trim()){
        h.name=newName.trim();
        save();
        render();
      }
    };
    div.querySelector(".changeCat").onclick=()=>{
      menu.style.display="none";
      const editCatModal=document.getElementById("editCategoryModal");
      editCatModal.classList.add("show");
      editCatModal.dataset.habitIndex=i;
      document.getElementById("editCategorySelect").value=h.category||'other';
    };
    div.querySelector(".changeEmoji").onclick=()=>{
      menu.style.display="none";
      const emojiModal=document.getElementById("streakEmojiModal");
      emojiModal.classList.add("show");
      emojiModal.dataset.habitIndex=i;
      document.getElementById("streakEmoji").value=h.streakEmoji||'';
    };
    div.querySelector(".deleteHist").onclick=(e)=>{
      e.stopPropagation();
      menu.style.display="none";
      setTimeout(()=>{
        if(confirm(`JesteÅ› pewien? Stracisz passÄ™ ${h.streakEmoji||'ğŸ”¥'}${h.streak}!`)){
          deletedHabit={...h};
          deletedIndex=i;
          habits.splice(i,1);
          save();
          render();
          showToast("Passa usuniÄ™ta","Cofnij",()=>{
            habits.splice(deletedIndex,0,deletedHabit);
            save();
            render();
          });
        }
      },100);
    };
    div.querySelector(".done").onclick=()=>{
      if(h.freeze) return;
      if(!h.datesDone.includes(today())){
        h.datesDone.push(today());
        h.streak++;
        save();
        render();
        // Animate streak
        setTimeout(()=>{
          const streakEl=document.getElementById(`streak-${i}`);
          if(streakEl) streakEl.classList.add('streak-bounce');
        },50);
      }
    };
    div.querySelector(".freeze").onclick=()=>{h.freeze=!h.freeze; div.classList.add("ice"); setTimeout(()=>div.classList.remove("ice"),800); save(); render();};

    div.append(toggle,cont);
    list.append(div);
    setTimeout(()=>div.classList.add("show"),10+i*50);
  });
  updateStats();
  },100); // End of setTimeout for loading skeleton
}

// Modal
const modal=document.getElementById("addModal");
document.getElementById("addBtn").onclick=()=>{
  modal.classList.add("show");
  document.getElementById("habitName").value="";
  document.getElementById("habitCategory").value="sport";
  document.getElementById("customCategory").style.display="none";
};

document.getElementById("habitCategory").onchange=(e)=>{
  const customInput=document.getElementById("customCategory");
  customInput.style.display=e.target.value==='custom'?'block':'none';
  if(e.target.value==='custom') customInput.focus();
};

document.getElementById("cancelBtn").onclick=()=>{
  modal.classList.remove("show");
};

document.getElementById("saveBtn").onclick=()=>{
  const n=document.getElementById("habitName").value.trim();
  let c=document.getElementById("habitCategory").value;
  if(c==='custom'){
    const custom=document.getElementById("customCategory").value.trim();
    if(!custom) return alert("Wpisz nazwÄ™ kategorii");
    c=custom;
  }
  if(n){
    habits.push({name:n,category:c,streak:0,datesDone:[],freezeDates:[],freeze:false,monthOffset:0,calendarOpen:false,editing:false});
    save();render();
    modal.classList.remove("show");
  }
};

modal.onclick=(e)=>{
  if(e.target===modal) modal.classList.remove("show");
};

// Edit Category Modal
const editCatModal=document.getElementById("editCategoryModal");

document.getElementById("editCategorySelect").onchange=(e)=>{
  const customInput=document.getElementById("editCustomCategory");
  customInput.style.display=e.target.value==='custom'?'block':'none';
  if(e.target.value==='custom') customInput.focus();
};

document.getElementById("cancelEditCatBtn").onclick=()=>{
  editCatModal.classList.remove("show");
};

document.getElementById("saveEditCatBtn").onclick=()=>{
  const idx=parseInt(editCatModal.dataset.habitIndex);
  let c=document.getElementById("editCategorySelect").value;
  if(c==='custom'){
    const custom=document.getElementById("editCustomCategory").value.trim();
    if(!custom) return alert("Wpisz nazwÄ™ kategorii");
    c=custom;
  }
  habits[idx].category=c;
  save();
  render();
  editCatModal.classList.remove("show");
};

editCatModal.onclick=(e)=>{
  if(e.target===editCatModal) editCatModal.classList.remove("show");
};

// Streak Emoji Modal
const streakEmojiModal=document.getElementById("streakEmojiModal");

document.getElementById("cancelStreakEmojiBtn").onclick=()=>{
  streakEmojiModal.classList.remove("show");
};

document.getElementById("saveStreakEmojiBtn").onclick=()=>{
  const idx=parseInt(streakEmojiModal.dataset.habitIndex);
  const emoji=document.getElementById("streakEmoji").value.trim();
  habits[idx].streakEmoji=emoji||'ğŸ”¥';
  save();
  render();
  streakEmojiModal.classList.remove("show");
};

streakEmojiModal.onclick=(e)=>{
  if(e.target===streakEmojiModal) streakEmojiModal.classList.remove("show");
};

// Quote refresh
document.getElementById("quoteRefresh").onclick=updateQuote;

// Language flags
document.querySelectorAll('.lang-flag').forEach(btn=>{
  btn.onclick=(e)=>{
    e.stopPropagation();
    switchQuoteLang(btn.dataset.lang);
  };
});

// Restore saved language
const savedLang=localStorage.getItem('quoteLang');
if(savedLang) currentQuoteLang=savedLang;

// Category stats toggle
document.getElementById("categoryStatsToggle").onclick=()=>{
  const list=document.getElementById("categoryStatsList");
  const toggle=document.getElementById("categoryStatsToggle");
  const sortButtons=document.getElementById("categorySortButtons");
  if(list.style.display==='none'){
    list.style.display='block';
    sortButtons.style.display='block';
    toggle.innerHTML='ğŸ“ˆ Statystyki per kategoria <span style="float:right">â–²</span>';
  }else{
    list.style.display='none';
    sortButtons.style.display='none';
    toggle.innerHTML='ğŸ“ˆ Statystyki per kategoria <span style="float:right">â–¼</span>';
  }
};

// Category sort buttons
document.getElementById("sortByName").onclick=()=>{
  renderCategoryStats('name');
};

document.getElementById("sortByDays").onclick=()=>{
  renderCategoryStats('days');
};

// Heat map toggle
document.getElementById("heatMapToggle").onclick=()=>{
  const container=document.getElementById("heatMapContainer");
  const toggle=document.getElementById("heatMapToggle");
  if(container.style.display==='none'){
    container.style.display='block';
    toggle.innerHTML='ğŸ“Š AktywnoÅ›Ä‡ (ostatnie 28 dni) <span style="float:right">â–²</span>';
  }else{
    container.style.display='none';
    toggle.innerHTML='ğŸ“Š AktywnoÅ›Ä‡ (ostatnie 28 dni) <span style="float:right">â–¼</span>';
  }
};

// Settings button - add to header for managing quotes
const settingsBtn=document.createElement("button");
settingsBtn.className="theme-toggle";
settingsBtn.style.left="0";
settingsBtn.style.right="auto";
settingsBtn.textContent="ğŸ’­";
settingsBtn.onclick=()=>{
  const quotesModal=document.getElementById("manageQuotesModal");
  quotesModal.classList.add("show");
  const customQuotes=JSON.parse(localStorage.getItem("customQuotes")||"[]");
  document.getElementById("customQuotes").value=customQuotes.join("\n");
  const savedLang=localStorage.getItem("quoteLanguage")||"pl";
  document.getElementById("quoteLanguage").value=savedLang;
};
document.querySelector(".header").append(settingsBtn);

// Manage Quotes Modal
const quotesModal=document.getElementById("manageQuotesModal");

document.getElementById("cancelQuotesBtn").onclick=()=>{
  quotesModal.classList.remove("show");
};

document.getElementById("saveQuotesBtn").onclick=()=>{
  const text=document.getElementById("customQuotes").value;
  const quotes=text.split("\n").map(q=>q.trim()).filter(q=>q);
  const language=document.getElementById("quoteLanguage").value;
  localStorage.setItem("customQuotes",JSON.stringify(quotes));
  localStorage.setItem("quoteLanguage",language);
  quotesModal.classList.remove("show");
  updateQuote();
  showToast("Cytaty zapisane! ğŸ’¾");
};

quotesModal.onclick=(e)=>{
  if(e.target===quotesModal) quotesModal.classList.remove("show");
};

// Initialize quote
updateQuote();

// Drag & drop for sections
let draggedSection=null;
const sections=[
  document.getElementById('quoteBox'),
  document.querySelector('.charts'),
  document.getElementById('categoryStats')
];

function setupSectionDragDrop(){
  sections.forEach((section,idx)=>{
    const handle=section.querySelector('.drag-section-handle');
    if(!handle) return;
    
    handle.ondragstart=(e)=>{
      draggedSection=section;
      section.style.opacity='0.5';
    };
    
    handle.ondragend=()=>{
      section.style.opacity='1';
      draggedSection=null;
    };
    
    section.ondragover=(e)=>{
      e.preventDefault();
    };
    
    section.ondrop=(e)=>{
      e.preventDefault();
      if(draggedSection && draggedSection!==section){
        const parent=section.parentNode;
        const allSections=Array.from(parent.children).filter(el=>
          el.dataset.section || el===draggedSection
        );
        const draggedIdx=allSections.indexOf(draggedSection);
        const targetIdx=allSections.indexOf(section);
        
        if(draggedIdx<targetIdx){
          parent.insertBefore(draggedSection,section.nextSibling);
        }else{
          parent.insertBefore(draggedSection,section);
        }
        
        // Save order
        const order=Array.from(parent.children)
          .filter(el=>el.dataset.section)
          .map(el=>el.dataset.section);
        localStorage.setItem('sectionOrder',JSON.stringify(order));
      }
    };
  });
}

// Restore section order
function restoreSectionOrder(){
  const savedOrder=localStorage.getItem('sectionOrder');
  if(!savedOrder) return;
  
  const order=JSON.parse(savedOrder);
  const statsDiv=document.getElementById('stats');
  
  order.forEach(sectionName=>{
    const section=document.querySelector(`[data-section="${sectionName}"]`);
    if(section && statsDiv.nextSibling){
      statsDiv.parentNode.insertBefore(section,statsDiv.nextSibling);
    }
  });
}

restoreSectionOrder();
setupSectionDragDrop();

// Close menu when clicking outside
document.addEventListener('click',(e)=>{
  if(!e.target.closest('.menu') && !e.target.closest('.more')){
    document.querySelectorAll('.menu').forEach(m=>m.style.display='none');
    document.querySelectorAll('.habit').forEach(h=>h.classList.remove('menu-open'));
  }
});

render();
</script>
</body>
</html>

