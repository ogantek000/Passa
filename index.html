<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keepy - Keep Going</title>
<link rel="icon" href="bro.jpg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üî•</text></svg>">

<style>
body {
  font-family: system-ui, -apple-system, sans-serif;
  background: #0f172a;
  color: white;
  margin: 0;
  padding: 16px;
}
.header {
  text-align: center;
  margin-bottom: 24px;
}
.mascot {
  width: 120px;
  height: 120px;
  margin: 0 auto 12px;
  display: block;
}
h1 { 
  margin: 8px 0 4px 0;
  font-size: 32px;
}
.motto {
  font-size: 14px;
  color: #94a3b8;
  margin: 0 0 8px 0;
}
h2 {
  font-size: 20px;
  margin: 16px 0;
}
.add {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #22c55e;
  color: black;
  font-size: 32px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
.habit {
  background: #020617;
  padding: 16px;
  border-radius: 14px;
  margin-bottom: 12px;
  display: flex;
  flex-direction: column;
  transition: all 0.3s ease;
  opacity: 1;
}
.habit.flash { animation: flash 0.5s; }
@keyframes flash {0% {background:#020617;}50% {background:#22c55e;}100% {background:#020617;}}
.habit.fade-out { animation: fadeOut 0.5s forwards; }
@keyframes fadeOut { to {opacity:0; transform: scale(0.8);} }

.habit-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.name { font-size: 18px; cursor: pointer; }
.streak { font-size: 22px; }
.actions button {
  margin-left: 6px;
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  cursor: pointer;
}
.done { background: #22c55e; }
.delete { background: #ef4444; color: white; }
.freeze { background: #facc15; color: black; }
.toggle-cal {
  background: #3b82f6;
  color: white;
  margin-top: 8px;
  width: 100%;
  padding: 8px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
}
.calendar-container { margin-top: 8px; }
.calendar { display: flex; flex-wrap: wrap; overflow: hidden; max-height: 0; transition: max-height 0.3s ease; }
.calendar.show { max-height: 400px; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.calendar-header button {
  background: #1e293b;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 12px;
  cursor: pointer;
}
.day {
  width: 14.2%;
  height: 24px;
  margin-bottom: 2px;
  text-align: center;
  line-height: 24px;
  font-size: 12px;
  border-radius: 4px;
  background: #111827;
}
.day.done { background: #22c55e; color: black; }
.day.freeze { background: #facc15; color: black; }
.day.missed { background: #ef4444; color: white; }
</style>
</head>
<body>

<div class="header">
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" class="mascot" id="mascot" alt="Keepy Mascot">
  <h1>Keepy</h1>
  <p class="motto">Keep Going</p>
  <h2>üî• Moje passy</h2>
</div>

<div id="list"></div>
<button class="add" id="addBtn">+</button>

<script>
// Za≈Çaduj maskotke
const mascotImg = document.getElementById('mascot');
fetch('/mnt/user-data/uploads/Gemini_Generated_Image_3xtul13xtul13xtu.png')
  .then(res => res.blob())
  .then(blob => {
    mascotImg.src = URL.createObjectURL(blob);
  })
  .catch(() => {
    // Fallback - poka≈º emoji je≈õli obrazek nie za≈Çaduje siƒô
    mascotImg.style.display = 'none';
  });

const list = document.getElementById("list");
const addBtn = document.getElementById("addBtn");
const today = () => new Date().toISOString().slice(0,10);
const yesterday = () => {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return d.toISOString().slice(0,10);
};

let habits = JSON.parse(localStorage.getItem("keepy-habits")) || [];

function save(){ localStorage.setItem("keepy-habits", JSON.stringify(habits)); }
function daysBetween(a,b){ return Math.floor((new Date(a)-new Date(b))/86400000); }

function wasYesterdayValid(h) {
  const yesterdayStr = yesterday();
  const yesterdayDone = h.datesDone && h.datesDone.includes(yesterdayStr);
  const yesterdayFreeze = h.freezeDates && h.freezeDates.includes(yesterdayStr);
  return yesterdayDone || yesterdayFreeze;
}

function renderCalendar(h, monthOffset=0){
  const container = document.createElement("div");
  container.className = "calendar-container";

  const calHeader = document.createElement("div");
  calHeader.className = "calendar-header";

  const left = document.createElement("button"); left.textContent="<";
  const right = document.createElement("button"); right.textContent=">";
  const title = document.createElement("span");

  let refDate = new Date();
  refDate.setMonth(refDate.getMonth()+monthOffset);
  title.textContent = refDate.toLocaleString('pl-PL',{month:'long', year:'numeric'});

  left.onclick = ()=>{ render(); };
  right.onclick = ()=>{ render(); };

  calHeader.appendChild(left);
  calHeader.appendChild(title);
  calHeader.appendChild(right);
  container.appendChild(calHeader);

  const calDiv = document.createElement("div");
  calDiv.className = "calendar";

  const firstDay = new Date(refDate.getFullYear(), refDate.getMonth(),1).getDay();
  const daysInMonth = new Date(refDate.getFullYear(), refDate.getMonth()+1,0).getDate();

  for(let i=0;i<(firstDay===0?6:firstDay-1);i++){ 
    const empty = document.createElement("div"); 
    empty.className="day"; 
    calDiv.appendChild(empty); 
  }

  for(let d=1;d<=daysInMonth;d++){
    const dayStr = `${refDate.getFullYear()}-${String(refDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayDiv = document.createElement("div");
    dayDiv.className="day"; dayDiv.textContent=d;

    const isDone = h.datesDone && h.datesDone.includes(dayStr);
    const isFreeze = h.freezeDates && h.freezeDates.includes(dayStr) && !isDone;
    
    let isMissed = false;
    if (!isDone && !isFreeze) {
      const allValidDates = [
        ...(h.datesDone || []),
        ...(h.freezeDates || [])
      ].sort();
      
      if (allValidDates.length > 0) {
        const latestValidDate = allValidDates[allValidDates.length - 1];
        if (new Date(dayStr) < new Date(latestValidDate) && new Date(dayStr) < new Date()) {
          isMissed = true;
        }
      }
    }

    if(isDone) {
      dayDiv.classList.add("done");
    } else if(isFreeze) {
      dayDiv.classList.add("freeze");
    } else if(isMissed) {
      dayDiv.classList.add("missed");
    }

    calDiv.appendChild(dayDiv);
  }

  container.appendChild(calDiv);
  container.monthOffset = monthOffset;
  return container;
}

function render(){
  list.innerHTML="";
  habits.forEach((h,i)=>{
    if(!h.freeze && h.lastDate){
      const diff = daysBetween(today(), h.lastDate);
      if(diff>=2) {
        let allDaysCovered = true;
        for(let d=1; d<diff; d++){
          const checkDate = new Date(h.lastDate);
          checkDate.setDate(checkDate.getDate() + d);
          const checkStr = checkDate.toISOString().slice(0,10);
          const hasFreeze = h.freezeDates && h.freezeDates.includes(checkStr);
          const hasDone = h.datesDone && h.datesDone.includes(checkStr);
          if(!hasFreeze && !hasDone) {
            allDaysCovered = false;
            break;
          }
        }
        if(!allDaysCovered) h.streak = 0;
      }
    }

    const div = document.createElement("div");
    div.className="habit";

    const doneToday = h.datesDone && h.datesDone.includes(today());
    const freeze = h.freeze===true;

    div.innerHTML = `
      <div class="habit-header">
        <div>
          <div class="name">${h.name}</div>
          <div class="streak">üî• ${h.streak}</div>
        </div>
        <div class="actions">
          <button class="done" ${doneToday||freeze?"disabled":""}>
            ${doneToday ? "Zrobione ‚úîÔ∏è" : "Zrobione dzi≈õ"}
          </button>
          <button class="freeze">${freeze ? "‚è∏Ô∏è" : "Freeze"}</button>
          <button class="delete">‚úï</button>
        </div>
      </div>
    `;

    const toggleBtn = document.createElement("button");
    toggleBtn.className = "toggle-cal";
    toggleBtn.textContent = "üìÖ Poka≈º kalendarz";
    div.appendChild(toggleBtn);

    let calendarDiv = renderCalendar(h, 0);
    div.appendChild(calendarDiv);

    toggleBtn.onclick=()=>{
      const cal = calendarDiv.querySelector(".calendar");
      cal.classList.toggle("show");
      toggleBtn.textContent = cal.classList.contains("show") ? "üìÖ Ukryj kalendarz" : "üìÖ Poka≈º kalendarz";
    };

    const leftBtn = calendarDiv.querySelector(".calendar-header button:first-child");
    const rightBtn = calendarDiv.querySelector(".calendar-header button:last-child");
    
    leftBtn.onclick = () => {
      const newCalendar = renderCalendar(h, calendarDiv.monthOffset - 1);
      div.replaceChild(newCalendar, calendarDiv);
      calendarDiv = newCalendar;
      if(toggleBtn.textContent.includes("Ukryj")) {
        calendarDiv.querySelector(".calendar").classList.add("show");
      }
      
      const newLeftBtn = calendarDiv.querySelector(".calendar-header button:first-child");
      const newRightBtn = calendarDiv.querySelector(".calendar-header button:last-child");
      newLeftBtn.onclick = leftBtn.onclick;
      newRightBtn.onclick = rightBtn.onclick;
    };
    
    rightBtn.onclick = () => {
      const newCalendar = renderCalendar(h, calendarDiv.monthOffset + 1);
      div.replaceChild(newCalendar, calendarDiv);
      calendarDiv = newCalendar;
      if(toggleBtn.textContent.includes("Ukryj")) {
        calendarDiv.querySelector(".calendar").classList.add("show");
      }
      
      const newLeftBtn = calendarDiv.querySelector(".calendar-header button:first-child");
      const newRightBtn = calendarDiv.querySelector(".calendar-header button:last-child");
      newLeftBtn.onclick = leftBtn.onclick;
      newRightBtn.onclick = rightBtn.onclick;
    };

    div.querySelector(".done").onclick=()=>{
      if(freeze) return;
      if(doneToday) return;
      if(!confirm(`Czy na pewno chcesz oznaczyƒá "${h.name}" jako zrobione?`)) return;

      if(!h.datesDone) h.datesDone=[];
      h.datesDone.push(today());
      
      if(wasYesterdayValid(h)) {
        h.streak++;
      } else {
        h.streak = 1;
      }
      
      h.lastDate=today();
      save();
      div.classList.add("flash");
      setTimeout(()=>div.classList.remove("flash"),500);
      render();
    };

    div.querySelector(".delete").onclick=()=>{
      if(!confirm(`Czy na pewno chcesz usunƒÖƒá passƒô "${h.name}"?`)) return;
      div.classList.add("fade-out");
      setTimeout(()=>{
        habits.splice(i,1);
        save();
        render();
      },500);
    };

    div.querySelector(".freeze").onclick=()=>{
      if(!confirm(`Czy na pewno chcesz ${freeze ? "odmroziƒá" : "zamroziƒá"} passƒô "${h.name}"?`)) return;
      h.freeze = !h.freeze;
      if(!h.freezeDates) h.freezeDates=[];
      if(h.freeze) {
        h.freezeDates.push(today());
        if(!h.lastDate || new Date(today()) > new Date(h.lastDate)) {
          h.lastDate = today();
        }
      }
      save();
      render();
    };

    list.appendChild(div);
  });
}

addBtn.onclick=()=>{
  const name=prompt("Nazwa nowej passy:");
  if(!name) return;
  habits.push({name, streak:0, lastDate:null, datesDone:[], freeze:false, freezeDates:[]});
  save();
  render();
};

render();
</script>

</body>
</html>


