<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Keepy ‚Äì Keep Going</title>
<link rel="icon" href="icon.png">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">
<link rel="apple-touch-icon" href="icon.png">

<style>
:root {
  --bg-primary: #0f172a;
  --bg-secondary: rgba(255,255,255,0.05);
  --bg-tertiary: #1e293b;
  --text-primary: white;
  --text-secondary: #94a3b8;
  --accent: #3b82f6;
  --success: #22c55e;
  --warning: #facc15;
  --danger: #ef4444;
}

* {
  -webkit-overflow-scrolling: touch;
}

html {
  scroll-behavior: auto;
}

[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: rgba(0,0,0,0.05);
  --bg-tertiary: #e2e8f0;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
}

[data-theme="ocean"] {
  --bg-primary: #0a192f;
  --bg-secondary: rgba(100,255,218,0.08);
  --bg-tertiary: #172a45;
  --accent: #64ffda;
  --text-primary: #ccd6f6;
  --text-secondary: #8892b0;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  margin:0;padding:16px;
  padding-bottom:max(24px,env(safe-area-inset-bottom));
  transition:background .3s, color .3s;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  -webkit-tap-highlight-color:transparent;
  overscroll-behavior:none;
  -webkit-user-select:none;
  -moz-user-select:none;
  -ms-user-select:none;
  user-select:none;
  touch-action:pan-y pinch-zoom;
}

input, textarea, [contenteditable]{
  -webkit-user-select:text;
  -moz-user-select:text;
  -ms-user-select:text;
  user-select:text;
}

.header{text-align:center;margin-bottom:10px;position:relative}
.theme-toggle{
  position:absolute;top:0;right:0;
  background:var(--bg-tertiary);border:none;
  padding:12px 16px;border-radius:10px;cursor:pointer;
  color:var(--text-primary);font-size:20px;
  min-width:44px;min-height:44px;
  transition:transform .2s, opacity .2s;
}
.theme-toggle:active{
  transform:scale(0.95);
  opacity:0.8;
}
.mascot{width:200px;height:200px;border-radius:50%;object-fit:cover}
h1{margin:6px 0 2px;color:var(--accent)}
.motto{color:var(--text-secondary);font-size:14px}
#countdown{font-size:16px;font-weight:600;color:var(--text-secondary);margin:6px 0 14px}

#stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  background:var(--bg-secondary);
  padding:12px;border-radius:14px;margin-bottom:14px;
}
#stats div{text-align:center;padding:8px}
#stats div div:first-child{font-size:13px;color:var(--text-secondary)}
#stats div div:last-child{font-size:18px;font-weight:bold;color:var(--accent)}

.charts{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:14px;
}
.charts h3{margin:0 0 12px;font-size:16px;color:var(--text-secondary)}
.heat-map{
  display:grid;grid-template-columns:repeat(7,1fr);
  gap:3px;margin-bottom:16px;
}
.heat-day{
  aspect-ratio:1;border-radius:3px;
  background:var(--bg-tertiary);
  font-size:9px;
  display:flex;align-items:center;justify-content:center;
  color:var(--text-secondary);
  position:relative;
}
.heat-day:hover{
  transform:scale(1.1);
  z-index:1;
  cursor:pointer;
}
.heat-day.level-1{background:#16a34a;opacity:0.3;color:white}
.heat-day.level-2{background:#16a34a;opacity:0.6;color:white}
.heat-day.level-3{background:#16a34a;opacity:0.9;color:white}
.heat-day.level-4{background:#16a34a;color:white}

.folder{
  background:var(--bg-secondary);
  padding:12px;border-radius:14px;margin-bottom:12px;
  border-left:4px solid var(--accent);
  position:relative;
  overflow:visible;
  z-index:1;
}
.folder.menu-open{z-index:200}
.folder-header{
  display:flex;align-items:center;justify-content:space-between;
  cursor:pointer;
  padding:8px;
  border-radius:8px;
  transition:background .2s;
}
.folder-header:hover{
  background:var(--bg-tertiary);
}
.folder-title{
  font-size:18px;font-weight:600;
  display:flex;align-items:center;gap:8px;
}
.folder-count{
  font-size:14px;
  color:var(--text-secondary);
  background:var(--bg-tertiary);
  padding:4px 10px;
  border-radius:12px;
}
.folder-content{
  margin-top:8px;
  display:none;
}
.folder-content.show{
  display:block;
}
.folder-actions{
  display:flex;gap:6px;margin-top:8px;
}
.folder-actions button{
  padding:6px 12px;
  border:none;
  border-radius:8px;
  background:var(--bg-tertiary);
  color:var(--text-primary);
  cursor:pointer;
  font-size:13px;
  transition:transform .2s, opacity .2s;
}
.folder-actions button:active{
  transform:scale(0.95);
  opacity:0.8;
}

.habit{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:12px;
  opacity:0;transform:translateY(20px);
  transition:all .4s cubic-bezier(0.34, 1.56, 0.64, 1);
  position:relative;
  border-left:4px solid transparent;
  scroll-margin-top:20px;
  overflow:visible;
  z-index:1;
}
.habit.show{opacity:1;transform:none}
.habit.menu-open{z-index:200}
.habit.editing-mode{
  border:2px solid #f97316;
  box-shadow:0 0 0 3px rgba(249,115,22,0.2);
}
.habit.move-mode{
  border:2px solid #8b5cf6;
  box-shadow:0 0 0 3px rgba(139,92,246,0.2);
}

.habit.ice::after{
  content:"‚ùÑÔ∏è";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(59,130,246,0.3), rgba(147,197,253,0.5), rgba(59,130,246,0.3));
  opacity:0;
  border-radius:14px;
  animation:ice 1.2s ease-in-out;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:80px;
  pointer-events:none;
}
@keyframes ice{
  0%{opacity:0;transform:scale(0.5) rotate(0deg)}
  15%{opacity:1;transform:scale(1.3) rotate(10deg)}
  30%{opacity:0.9;transform:scale(1.1) rotate(-5deg)}
  50%{opacity:0.8;transform:scale(1.15) rotate(3deg)}
  70%{opacity:0.6;transform:scale(1.05) rotate(-2deg)}
  100%{opacity:0;transform:scale(1) rotate(0deg)}
}

.category-badge{
  display:inline-block;
  padding:4px 12px;border-radius:12px;
  font-size:12px;font-weight:600;
  margin-bottom:8px;
}
.frequency-badge{
  display:inline-block;
  padding:4px 10px;border-radius:10px;
  font-size:11px;font-weight:600;
  margin-left:6px;
  background:var(--bg-tertiary);
  color:var(--text-secondary);
}
.cat-sport{background:#3b82f6;color:white}
.cat-health{background:#22c55e;color:white}
.cat-work{background:#f59e0b;color:white}
.cat-study{background:#8b5cf6;color:white}
.cat-hobby{background:#ec4899;color:white}
.cat-other{background:#6b7280;color:white}

.habit-header{
  display:flex;flex-direction:column;gap:12px
}
.habit-info{
  display:flex;flex-direction:column;align-items:center;gap:6px
}
.name{font-size:18px;font-weight:600;text-align:center}
.streak{
  font-size:24px;color:#ff9500;
  position:relative;
  overflow:hidden;
  min-height:30px;
  display:flex;align-items:center;justify-content:center;
}
.streak-number{
  display:inline-block;
  animation:slideDown .4s ease-out;
  transition:transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.streak-number.bump{
  animation:bumpScale 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes slideDown{
  from{
    transform:translateY(-100%);
    opacity:0;
  }
  to{
    transform:translateY(0);
    opacity:1;
  }
}
@keyframes bumpScale{
  0%{transform:scale(1)}
  40%{transform:scale(1.15) rotate(-3deg)}
  60%{transform:scale(1.12) rotate(2deg)}
  80%{transform:scale(1.1) rotate(-1deg)}
  100%{transform:scale(1) rotate(0deg)}
}

.actions{display:flex;gap:6px;flex-wrap:wrap}
.actions button{
  padding:8px 12px;border:none;border-radius:8px;cursor:pointer;
  font-size:13px;
  min-height:38px;
  font-weight:500;
  transition:transform .2s, opacity .2s, background .2s;
  flex:1;
  min-width:90px;
}
.actions button:active{
  transform:scale(0.95);
  opacity:0.8;
}
.done{background:var(--success);color:white}
.done.completed{
  background:#059669;
  position:relative;
}
.done.completed::after{
  content:"‚úì";
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  font-size:16px;
  font-weight:bold;
}
.freeze{background:var(--warning);color:black}
.freeze.active{
  background:#ca8a04;
}
.more{background:var(--bg-tertiary);color:var(--text-primary);font-size:18px;min-width:38px;flex:0}

.move-buttons{
  display:none;
  gap:8px;
  margin-top:12px;
  padding:12px;
  background:var(--bg-tertiary);
  border-radius:10px;
}
.move-buttons.show{
  display:flex;
}
.move-buttons button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:white;
  font-weight:600;
  cursor:pointer;
  min-height:44px;
  transition:transform .2s, opacity .2s;
}
.move-buttons button:active{
  transform:scale(0.95);
  opacity:0.8;
}
.move-buttons button:disabled{
  opacity:0.3;
  cursor:not-allowed;
}

.menu{
  position:absolute;right:12px;top:52px;
  background:rgba(30,41,59,0.7);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border-radius:16px;
  overflow:hidden;display:none;
  box-shadow:0 10px 40px rgba(0,0,0,.5), 0 0 0 0.5px rgba(255,255,255,0.1) inset;
  z-index:100;
  border:1px solid rgba(255,255,255,0.1);
  min-width:220px;
}
[data-theme="light"] .menu{
  background:rgba(248,250,252,0.8);
  border:1px solid rgba(0,0,0,0.1);
}
.menu button{
  width:100%;padding:14px 16px;
  background:none;border:none;color:var(--text-primary);
  text-align:left;cursor:pointer;
  font-size:15px;
  min-height:48px;
  transition:background .2s;
  display:flex;align-items:center;gap:12px;
  border-bottom:0.5px solid rgba(255,255,255,0.08);
}
[data-theme="light"] .menu button{
  border-bottom:0.5px solid rgba(0,0,0,0.06);
}
.menu button:last-child{
  border-bottom:none;
}
.menu button:active{
  background:rgba(255,255,255,0.1);
  transform:scale(0.98);
}
[data-theme="light"] .menu button:active{
  background:rgba(0,0,0,0.05);
}
.menu button.danger{
  color:#ff453a;
}
.menu button.danger:active{
  background:rgba(255,69,58,0.15);
}
.submenu{
  position:absolute;
  right:12px;
  top:52px;
  background:rgba(30,41,59,0.7);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border-radius:16px;
  overflow:hidden;
  display:none;
  box-shadow:0 10px 40px rgba(0,0,0,.5), 0 0 0 0.5px rgba(255,255,255,0.1) inset;
  z-index:100;
  border:1px solid rgba(255,255,255,0.1);
  min-width:220px;
}
[data-theme="light"] .submenu{
  background:rgba(248,250,252,0.8);
  border:1px solid rgba(0,0,0,0.1);
}
.submenu button{
  width:100%;
  padding:14px 16px;
  background:none;
  border:none;
  color:var(--text-primary);
  text-align:left;
  cursor:pointer;
  font-size:15px;
  min-height:48px;
  transition:background .2s;
  display:flex;
  align-items:center;
  gap:12px;
  border-bottom:0.5px solid rgba(255,255,255,0.08);
}
[data-theme="light"] .submenu button{
  border-bottom:0.5px solid rgba(0,0,0,0.06);
}
.submenu button:last-child{
  border-bottom:none;
}
.submenu button:active{
  background:rgba(255,255,255,0.1);
  transform:scale(0.98);
}
[data-theme="light"] .submenu button:active{
  background:rgba(0,0,0,0.05);
}

.toggle-cal{
  width:100%;margin-top:8px;
  padding:12px;border:none;border-radius:10px;
  background:var(--accent);color:white;cursor:pointer;
  font-weight:500;font-size:15px;
  min-height:44px;
  transition:transform .2s, opacity .2s;
}
.toggle-cal:active{
  transform:scale(0.98);
  opacity:0.9;
}

.calendar-container{margin-top:8px;position:relative;overflow:hidden}
.calendar{
  overflow:hidden;
  transition:all .3s ease;
  pointer-events:none;
  opacity:0;
  max-height:0;
}
.calendar.show{
  opacity:1;
  pointer-events:auto;
  max-height:500px;
}

.calendar.editing{
  outline:2px dashed #f97316
}

.calendar-nav{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:8px;
  gap:12px;
}
.calendar-nav span{
  color:var(--text-primary);font-weight:bold;
  flex:1;text-align:center;
}
.calendar-nav button{
  background:var(--bg-tertiary);color:var(--text-primary);border:none;
  padding:8px 14px;border-radius:8px;
  cursor:pointer;flex-shrink:0;
  font-size:16px;
  min-height:44px;
  min-width:44px;
  transition:transform .2s, opacity .2s;
  touch-action:manipulation;
}
.calendar-nav button:active{
  transform:scale(0.95);
  opacity:0.8;
}

.calendar-days{
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.calendar-weekdays{
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 8px;
}

.calendar-weekday{
  text-align: center;
  font-size: 10px;
  font-weight: 600;
  color: var(--text-secondary);
  padding: 4px 0;
}

.day{
  width: 14.2%;
  height: 32px;
  line-height: 32px;
  text-align: center;
  font-size: 12px;
  border-radius: 6px;
  background: var(--bg-tertiary);
  transition: transform .2s;
  position: relative;
}
.day.today{
  border:2px solid var(--accent);
  box-shadow:0 0 0 2px rgba(59,130,246,0.3);
}
.day.week-done{
  background:var(--success);
  color:white;
  opacity:0.6;
}
.day.week-freeze{
  background:var(--warning);
  color:black;
  opacity:0.6;
}
.day.week-missed{
  background:var(--danger);
  color:white;
  opacity:0.5;
}
.calendar.editing .day{cursor:pointer}
.calendar.editing .day:active{
  transform:scale(0.9);
}

.day.done{background:var(--success);color:white}
.day.freeze{background:var(--warning);color:black}
.day.missed{background:var(--danger);color:white}
.day.locked{opacity:.35}

.add{
  position:fixed;bottom:max(24px,env(safe-area-inset-bottom));right:24px;
  width:60px;height:60px;border-radius:50%;
  background:var(--success);color:white;font-size:32px;border:none;cursor:pointer;
  box-shadow:0 4px 20px rgba(34,197,94,0.4);
  transition:transform .3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow .3s;
  z-index:10;
}
.add:active{
  transform:scale(0.9);
  box-shadow:0 2px 10px rgba(34,197,94,0.3);
}

.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,0.7);z-index:100;
  align-items:center;justify-content:center;
  animation:fadeIn .3s ease;
}
.modal.show{display:flex}
@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}
.modal-content{
  background:var(--bg-primary);
  padding:24px;border-radius:16px;
  max-width:400px;width:90%;
  border:1px solid var(--bg-tertiary);
  animation:slideUp .4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes slideUp{
  from{transform:translateY(50px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
.modal h3{margin:0 0 16px;color:var(--accent)}
.modal input, .modal select{
  width:100%;padding:10px;margin-bottom:12px;
  border:1px solid var(--bg-tertiary);
  border-radius:8px;background:var(--bg-secondary);
  color:var(--text-primary);
  box-sizing:border-box;
}
.modal-buttons{
  display:flex;gap:8px;justify-content:flex-end;
}
.modal-buttons button{
  padding:12px 20px;border:none;border-radius:10px;cursor:pointer;
  font-size:16px;font-weight:500;
  min-height:44px;min-width:80px;
  transition:transform .2s, opacity .2s;
}
.modal-buttons button:active{
  transform:scale(0.95);
  opacity:0.8;
}
.btn-primary{background:var(--accent);color:white}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary)}

.quote-box{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:14px;
  position:relative;
  border-left:4px solid var(--accent);
}
.quote-text{
  font-style:italic;color:var(--text-primary);
  font-size:15px;line-height:1.5;
}

.empty-state{
  text-align:center;
  padding:60px 20px;
  background:var(--bg-secondary);
  border-radius:14px;
  margin:20px 0;
}

.category-stats{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:14px;
}
.category-stat-item{
  display:flex;justify-content:space-between;
  padding:8px 0;border-bottom:1px solid var(--bg-tertiary);
}
.category-stat-item:last-child{border:none}

.toast{
  position:fixed;bottom:100px;left:50%;
  transform:translateX(-50%) translateY(100px);
  background:var(--bg-primary);
  padding:16px 20px;border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.5);
  border:1px solid var(--bg-tertiary);
  display:flex;gap:12px;align-items:center;
  z-index:200;
  opacity:0;
  transition:all .3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.toast.show{
  transform:translateX(-50%) translateY(0);
  opacity:1;
}
.toast button{
  background:var(--accent);color:white;
  border:none;padding:8px 16px;border-radius:8px;
  cursor:pointer;font-weight:500;
}

.loading-skeleton{
  background:linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
  background-size:200% 100%;
  animation:shimmer 1.5s infinite;
  border-radius:14px;
  height:120px;
  margin-bottom:12px;
}
@keyframes shimmer{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}

.streak-bounce{
  animation:bounce .5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes bounce{
  0%, 100%{transform:scale(1)}
  50%{transform:scale(1.3)}
}
</style>
</head>
<body>

<div class="header">
  <button class="theme-toggle" id="themeBtn">üåô</button>
  <img src="bro" class="mascot">
  <h1>Keepy</h1>
  <p class="motto">Keep Going</p>
  <div id="countdown">--:--:--</div>
</div>

<div id="stats">
  <div><div>Dzisiaj</div><div id="todayStats">0/0</div></div>
  <div><div>Dni wykonane</div><div id="totalDone">0</div></div>
  <div><div>Najd≈Çu≈ºsza passa</div><div id="maxStreak">0</div></div>
  <div><div>≈örednia dzienna</div><div id="avgDaily">0</div></div>
  <div><div>Rekord ≈ºyciowy</div><div id="bestEver">0</div></div>
  <div><div>U≈ºyte freeze'y</div><div id="totalFreezes">0</div></div>
</div>

<div class="quote-box" id="quoteBox">
  <div class="quote-text" id="quoteText" style="margin-bottom:12px"></div>
  <div style="display:flex;gap:8px;justify-content:center">
    <button class="lang-flag" data-lang="pl" style="background:var(--bg-tertiary);border:none;font-size:18px;cursor:pointer;opacity:0.5;transition:opacity .2s,transform .2s;padding:8px 12px;border-radius:8px;min-width:44px">üáµüá±</button>
    <button class="lang-flag" data-lang="en" style="background:var(--bg-tertiary);border:none;font-size:18px;cursor:pointer;opacity:0.5;transition:opacity .2s,transform .2s;padding:8px 12px;border-radius:8px;min-width:44px">üá¨üáß</button>
    <button class="lang-flag" data-lang="es" style="background:var(--bg-tertiary);border:none;font-size:18px;cursor:pointer;opacity:0.5;transition:opacity .2s,transform .2s;padding:8px 12px;border-radius:8px;min-width:44px">üá™üá∏</button>
  </div>
</div>

<div class="charts">
  <h3 style="font-size:16px;color:var(--text-secondary);margin:0 0 8px;cursor:pointer" id="heatMapToggle">
    üìä Aktywno≈õƒá (ostatnie 28 dni) <span style="float:right">‚ñº</span>
  </h3>
  <div id="heatMapContainer" style="display:none">
    <p style="font-size:13px;color:var(--text-secondary);margin:0 0 12px">Ka≈ºdy kwadrat to jeden dzie≈Ñ. Im ciemniejszy kolor, tym wiƒôcej pass zrobi≈Çe≈õ tego dnia.</p>
    <div class="heat-map" id="heatMap"></div>
  </div>
</div>

<div class="category-stats" id="categoryStats" style="display:none">
  <h3 style="font-size:16px;color:var(--text-secondary);margin:0 0 12px;cursor:pointer" id="categoryStatsToggle">
    üìà Statystyki per kategoria <span style="float:right">‚ñº</span>
  </h3>
  <div id="categoryStatsList" style="display:none"></div>
</div>

<div style="margin-bottom:14px">
  <input type="text" id="searchInput" placeholder="üîç Szukaj passy..." style="width:100%;padding:12px;border:1px solid var(--bg-tertiary);border-radius:10px;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box;font-size:15px">
</div>

<div class="empty-state" id="emptyState" style="display:none">
  <div style="font-size:60px;margin-bottom:16px">üí™</div>
  <h2 style="color:var(--accent);margin:0 0 8px">Zacznij swojƒÖ przygodƒô!</h2>
  <p style="color:var(--text-secondary);margin:0">Dodaj swojƒÖ pierwszƒÖ passƒô i buduj nawyki ka≈ºdego dnia</p>
</div>

<div id="foldersContainer"></div>
<div id="list"></div>
<button class="add" id="addBtn">+</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3 id="addModalTitle">‚ûï Dodaj nowƒÖ passƒô</h3>
    <div style="margin-bottom:12px">
      <label style="font-size:14px;color:var(--text-secondary);display:block;margin-bottom:8px">Typ:</label>
      <div style="display:flex;gap:8px">
        <button id="addTypeHabit" style="flex:1;padding:10px;border:2px solid var(--accent);background:var(--accent);color:white;border-radius:8px;cursor:pointer;font-weight:600">üìù Passa</button>
        <button id="addTypeFolder" style="flex:1;padding:10px;border:2px solid var(--bg-tertiary);background:var(--bg-tertiary);color:var(--text-primary);border-radius:8px;cursor:pointer;font-weight:600">üìÅ Folder</button>
      </div>
    </div>
    <div id="habitFields">
      <input type="text" id="habitName" placeholder="Nazwa passy">
      <select id="habitCategory">
        <option value="sport">üèÉ Sport</option>
        <option value="health">üíö Zdrowie</option>
        <option value="work">üíº Praca</option>
        <option value="study">üìö Nauka</option>
        <option value="hobby">üé® Hobby</option>
        <option value="other">‚ö™ Inne</option>
        <option value="custom">‚ûï W≈Çasna kategoria...</option>
      </select>
      <input type="text" id="customCategory" placeholder="Wpisz nazwƒô w≈Çasnej kategorii" style="display:none">
      <select id="habitFrequency">
        <option value="daily">üìÖ Codziennie</option>
        <option value="weekly">üìÜ Tygodniowo (min 1x w tygodniu)</option>
      </select>
      <select id="habitFolder">
        <option value="">Bez folderu</option>
      </select>
    </div>
    <div id="folderFields" style="display:none">
      <input type="text" id="folderName" placeholder="Nazwa folderu">
      <input type="text" id="folderEmoji" placeholder="Emoji folderu (np. üí™, üéØ, üìö)" maxlength="2">
    </div>
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelBtn">Anuluj</button>
      <button class="btn-primary" id="saveBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="modal" id="editCategoryModal">
  <div class="modal-content">
    <h3>üè∑Ô∏è Zmie≈Ñ kategoriƒô</h3>
    <select id="editCategorySelect">
      <option value="sport">üèÉ Sport</option>
      <option value="health">üíö Zdrowie</option>
      <option value="work">üíº Praca</option>
      <option value="study">üìö Nauka</option>
      <option value="hobby">üé® Hobby</option>
      <option value="other">‚ö™ Inne</option>
      <option value="custom">‚ûï W≈Çasna kategoria...</option>
    </select>
    <input type="text" id="editCustomCategory" placeholder="Wpisz nazwƒô w≈Çasnej kategorii" style="display:none">
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelEditCatBtn">Anuluj</button>
      <button class="btn-primary" id="saveEditCatBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="modal" id="streakEmojiModal">
  <div class="modal-content">
    <h3>üî• Personalizuj emoji passy</h3>
    <input type="text" id="streakEmoji" placeholder="np. üî•, üöÄ, ‚≠ê, üíé" maxlength="2">
    <p style="font-size:13px;color:var(--text-secondary);margin:8px 0">Wpisz swoje ulubione emoji (lub zostaw puste dla domy≈õlnego üî•)</p>
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelStreakEmojiBtn">Anuluj</button>
      <button class="btn-primary" id="saveStreakEmojiBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="modal" id="manageQuotesModal">
  <div class="modal-content">
    <h3>üí≠ ZarzƒÖdzaj cytatami</h3>
    <label style="font-size:14px;color:var(--text-secondary);display:block;margin-bottom:8px">Jƒôzyk domy≈õlnych cytat√≥w:</label>
    <select id="quoteLanguage" style="width:100%;padding:10px;margin-bottom:12px;border:1px solid var(--bg-tertiary);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box">
      <option value="pl">üáµüá± Polski</option>
      <option value="en">üá¨üáß Angielski</option>
      <option value="es">üá™üá∏ Hiszpa≈Ñski</option>
    </select>
    <label style="font-size:14px;color:var(--text-secondary);display:block;margin-bottom:8px">W≈Çasne cytaty:</label>
    <textarea id="customQuotes" placeholder="Wpisz w≈Çasne cytaty (ka≈ºdy w nowej linii)" rows="8" style="width:100%;padding:10px;border:1px solid var(--bg-tertiary);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box;font-family:inherit;margin-bottom:8px"></textarea>
    <p style="font-size:13px;color:var(--text-secondary);margin:8px 0">Domy≈õlne cytaty w wybranym jƒôzyku + Twoje w≈Çasne bƒôdƒÖ losowo wy≈õwietlane</p>
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelQuotesBtn">Anuluj</button>
      <button class="btn-primary" id="saveQuotesBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="modal" id="deleteConfirmModal">
  <div class="modal-content">
    <h3 style="color:var(--danger)">üóëÔ∏è Usu≈Ñ passƒô?</h3>
    <p style="color:var(--text-secondary);margin:16px 0">Czy na pewno chcesz usunƒÖƒá passƒô <strong id="deleteHabitName"></strong>?</p>
    <p style="color:var(--danger);font-size:14px;margin:12px 0">Stracisz passƒô <span id="deleteHabitStreak"></span>!</p>
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelDeleteBtn">Anuluj</button>
      <button class="btn-primary" id="confirmDeleteBtn" style="background:var(--danger)">Usu≈Ñ</button>
    </div>
  </div>
</div>

<div class="modal" id="deleteFolderModal">
  <div class="modal-content">
    <h3 style="color:var(--danger)">üóëÔ∏è Usu≈Ñ folder?</h3>
    <p style="color:var(--text-secondary);margin:16px 0">Czy na pewno chcesz usunƒÖƒá folder <strong id="deleteFolderName"></strong>?</p>
    <p style="color:var(--text-secondary);font-size:14px;margin:12px 0">Passy zostanƒÖ przeniesione do g≈Ç√≥wnej listy.</p>
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelDeleteFolderBtn">Anuluj</button>
      <button class="btn-primary" id="confirmDeleteFolderBtn" style="background:var(--danger)">Usu≈Ñ</button>
    </div>
  </div>
</div>

<div class="modal" id="editFolderModal">
  <div class="modal-content">
    <h3>üìÅ Edytuj folder</h3>
    <input type="text" id="editFolderName" placeholder="Nazwa folderu">
    <input type="text" id="editFolderEmoji" placeholder="Emoji folderu (np. üí™, üéØ, üìö)" maxlength="2">
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelEditFolderBtn">Anuluj</button>
      <button class="btn-primary" id="saveEditFolderBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <span id="toastText"></span>
  <button id="toastAction" style="display:none"></button>
</div>

<script>
const DAY=86400000;
const list=document.getElementById("list");
const foldersContainer=document.getElementById("foldersContainer");
const themes=['dark','light','ocean'];
let currentTheme=0;
let deletedHabit=null;
let deletedIndex=null;
let movingHabitIndex=null;
let addingType='habit';

const defaultQuotes=[
  {
    pl: "Sukces to suma ma≈Çych wysi≈Çk√≥w powtarzanych dzie≈Ñ po dniu.",
    en: "Success is the sum of small efforts repeated day after day.",
    es: "El √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a."
  },
  {
    pl: "Nie liczy siƒô perfekcja, liczy siƒô konsekwencja.",
    en: "It's not about perfection, it's about consistency.",
    es: "No se trata de perfecci√≥n, se trata de consistencia."
  },
  {
    pl: "Ka≈ºdy dzie≈Ñ to nowa szansa na bycie lepszƒÖ wersjƒÖ siebie.",
    en: "Every day is a new chance to be a better version of yourself.",
    es: "Cada d√≠a es una nueva oportunidad para ser mejor."
  },
  {
    pl: "Nawyki budujƒÖ przysz≈Ço≈õƒá, kt√≥rƒÖ sobie wymarzy≈Çe≈õ.",
    en: "Habits build the future you dreamed of.",
    es: "Los h√°bitos construyen el futuro que so√±aste."
  },
  {
    pl: "Ma≈Ça zmiana dzi≈õ = wielka r√≥≈ºnica jutro.",
    en: "Small change today = big difference tomorrow.",
    es: "Peque√±o cambio hoy = gran diferencia ma√±ana."
  },
  {
    pl: "Nie rezygnuj! Jeste≈õ bli≈ºej ni≈º my≈õlisz.",
    en: "Don't give up! You're closer than you think.",
    es: "¬°No te rindas! Est√°s m√°s cerca de lo que crees."
  },
  {
    pl: "Twoja przysz≈Ço≈õƒá jest tworzona przez to, co robisz dzisiaj.",
    en: "Your future is created by what you do today.",
    es: "Tu futuro se crea por lo que haces hoy."
  },
  {
    pl: "Motywacja Ciƒô uruchamia. Nawyk Ciƒô prowadzi.",
    en: "Motivation gets you started. Habit keeps you going.",
    es: "La motivaci√≥n te pone en marcha. El h√°bito te mantiene."
  },
  {
    pl: "BƒÖd≈∫ silniejszy ni≈º twoje wym√≥wki.",
    en: "Be stronger than your excuses.",
    es: "S√© m√°s fuerte que tus excusas."
  },
  {
    pl: "Dzisiaj jest dobry dzie≈Ñ, ≈ºeby byƒá produktywnym!",
    en: "Today is a good day to be productive!",
    es: "¬°Hoy es un buen d√≠a para ser productivo!"
  },
  {
    pl: "Pewno≈õƒá siebie pochodzi z przygotowania.",
    en: "Confidence comes from preparation.",
    es: "La confianza nace de la preparaci√≥n."
  },
  {
    pl: "Cele to marzenia z terminem realizacji.",
    en: "Goals are dreams with deadlines.",
    es: "Las metas son sue√±os con fecha l√≠mite."
  },
  {
    pl: "Niewiele da siƒô zrobiƒá w duchu strachu.",
    en: "Little can be done under the spirit of fear.",
    es: "Poco se puede lograr bajo el esp√≠ritu del miedo."
  },
  {
    pl: "Je≈õli chcesz mieƒá satysfakcjonujƒÖce ≈ºycie, musisz wstawaƒá z determinacjƒÖ.",
    en: "If you want to have a satisfactory life, you've got to get up with determination.",
    es: "Si quieres tener una vida satisfactoria, debes levantarte con determinaci√≥n."
  },
  {
    pl: "CANEI: ciƒÖg≈Çe i nieko≈ÑczƒÖce siƒô doskonalenie.",
    en: "CANEI: continuous and never-ending improvement.",
    es: "CANEI: mejora continua e interminable."
  },
  {
    pl: "Szale≈Ñstwem jest robiƒá wciƒÖ≈º to samo i oczekiwaƒá innych rezultat√≥w.",
    en: "It is insane to do the same thing over and over again and expect different results.",
    es: "Es una locura hacer lo mismo una y otra vez y esperar resultados diferentes."
  },
  {
    pl: "Najlepsi liderzy potrafiƒÖ sprawiƒá, ≈ºe zwykli ludzie robiƒÖ niezwyk≈Çe rzeczy.",
    en: "The best leaders are capable of making common people do uncommon things.",
    es: "Los mejores l√≠deres son capaces de hacer que la gente com√∫n haga cosas extraordinarias."
  },
  {
    pl: "Karm sw√≥j umys≈Ç bia≈Çkiem mentalnym, a nie mentalnymi s≈Çodyczami.",
    en: "Feed your mind with mental protein rather than mental candy.",
    es: "Alimenta tu mente con prote√≠na mental en lugar de dulces mentales."
  },
  {
    pl: "Je≈õli jeste≈õ w lesie i nie wiesz, dokƒÖd i≈õƒá ‚Äì zacznij i≈õƒá.",
    en: "If you are in the woods and you don't know where to go, start walking.",
    es: "Si est√°s en el bosque y no sabes a d√≥nde ir, empieza a caminar."
  },
  {
    pl: "Czytelnicy sƒÖ zwyciƒôzcami.",
    en: "Readers are winners.",
    es: "Los lectores son ganadores."
  },
  {
    pl: "Spodziewaj siƒô niespodziewanego.",
    en: "Expect the unexpected.",
    es: "Espera lo inesperado."
  },
  {
    pl: "Je≈õli chcesz zmieniƒá swojƒÖ przysz≈Ço≈õƒá, dzia≈Çaj ‚Äì i dzia≈Çaj teraz.",
    en: "If you want to change your future, take action and take it now.",
    es: "Si quieres cambiar tu futuro, act√∫a y hazlo ahora."
  },
  {
    pl: "Gdy patrzysz na s≈Ço≈Ñce, wszystkie cienie zostajƒÖ za tobƒÖ.",
    en: "When you look at the sun, you leave all the shadows behind you.",
    es: "Cuando miras al sol, dejas todas las sombras detr√°s de ti."
  },
  {
    pl: "Baw siƒô dobrze, pracujƒÖc.",
    en: "Have fun working.",
    es: "Divi√©rtete trabajando."
  },
  {
    pl: "Traktuj siebie jak projekt bez ko≈Ñca.",
    en: "Treat yourself as a never-ending project.",
    es: "Tr√°tate como un proyecto sin fin."
  },
  {
    pl: "Je≈õli bƒôdziesz to robiƒá dalej, stanie siƒô to nawykiem.",
    en: "If you keep doing this, it becomes a habit.",
    es: "Si sigues haci√©ndolo, se convierte en un h√°bito."
  },
  {
    pl: "Spodziewaj siƒô tego, co spodziewane.",
    en: "Expect the expectable.",
    es: "Espera lo esperable."
  },
  {
    pl: "BƒÖd≈∫ mistrzem, zanim nim zostaniesz.",
    en: "Be the champion before you become the champion.",
    es: "S√© el campe√≥n antes de convertirte en campe√≥n."
  },
  {
    pl: "Ignoruj szum.",
    en: "Ignore the noise.",
    es: "Ignora el ruido."
  },
  {
    pl: "Trzeba w≈Ço≈ºyƒá wiƒôcej wysi≈Çku, by co≈õ wyglƒÖda≈Ço na bezwysi≈Çkowe.",
    en: "You have to put in more effort to make something appear effortless.",
    es: "Hay que esforzarse m√°s para que algo parezca sin esfuerzo."
  },
  {
    pl: "Nigdy nie zbaczaj z drogi.",
    en: "Never stray from the way.",
    es: "Nunca te desv√≠es del camino."
  },
  {
    pl: "Si≈Ça woli jest jak miƒôsie≈Ñ ‚Äì je≈õli przeciƒÖ≈ºysz jƒÖ, mƒôczy siƒô.",
    en: "Willpower is like a muscle; if you work it too hard, it gets tired.",
    es: "La fuerza de voluntad es como un m√∫sculo: si lo trabajas demasiado, se cansa."
  },
  {
    pl: "Niepoddawanie siƒô to najlepsza umiejƒôtno≈õƒá.",
    en: "Not quitting is the best skill.",
    es: "No rendirse es la mejor habilidad."
  },
  {
    pl: "Wizualizuj most.",
    en: "Visualise the bridge.",
    es: "Visualiza el puente."
  },
  {
    pl: "Gdy przestajesz siƒô zmieniaƒá, jeste≈õ sko≈Ñczony.",
    en: "When you stop changing, you are finished.",
    es: "Cuando dejas de cambiar, est√°s acabado."
  },
  {
    pl: "Im wiƒôcej siƒô uczƒô, tym bardziej zdajƒô sobie sprawƒô, jak ma≈Ço wiem.",
    en: "The more I learn, the more I realize how much I don't know.",
    es: "Cuanto m√°s aprendo, m√°s me doy cuenta de lo poco que s√©."
  },
  {
    pl: "To, czego boimy siƒô najbardziej, czƒôsto jest dok≈Çadnie tym, czego najbardziej unikamy.",
    en: "The thing we fear the most is often the thing we avoid the most.",
    es: "Aquello que m√°s tememos suele ser aquello que m√°s evitamos."
  }
];

let currentQuoteIndex=0;
let currentQuoteLang='pl';

function showToast(text,actionText,actionCallback){
  const toast=document.getElementById("toast");
  const toastText=document.getElementById("toastText");
  const toastAction=document.getElementById("toastAction");
  
  toastText.textContent=text;
  if(actionText){
    toastAction.textContent=actionText;
    toastAction.style.display='block';
    toastAction.onclick=()=>{
      actionCallback();
      toast.classList.remove("show");
    };
  }else{
    toastAction.style.display='none';
  }
  
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),4000);
}

function getDailyQuote(){
  const savedDate=localStorage.getItem('quoteDate');
  const savedIndex=localStorage.getItem('quoteIndex');
  const currentDate=today();
  
  if(savedDate!==currentDate || !savedIndex){
    currentQuoteIndex=Math.floor(Math.random()*defaultQuotes.length);
    localStorage.setItem('quoteDate',currentDate);
    localStorage.setItem('quoteIndex',currentQuoteIndex);
  }else{
    currentQuoteIndex=parseInt(savedIndex);
  }
  
  if(currentQuoteIndex>=defaultQuotes.length){
    currentQuoteIndex=0;
    localStorage.setItem('quoteIndex','0');
  }
  
  return defaultQuotes[currentQuoteIndex][currentQuoteLang];
}

function updateQuote(){
  const quote=getDailyQuote();
  document.getElementById("quoteText").textContent=quote;
  updateLangFlags();
}

function updateLangFlags(){
  document.querySelectorAll('.lang-flag').forEach(btn=>{
    if(btn.dataset.lang===currentQuoteLang){
      btn.style.opacity='1';
      btn.style.transform='scale(1.1)';
    }else{
      btn.style.opacity='0.5';
      btn.style.transform='scale(1)';
    }
  });
}

function switchQuoteLang(lang){
  currentQuoteLang=lang;
  localStorage.setItem('quoteLang',lang);
  document.getElementById("quoteText").textContent=defaultQuotes[currentQuoteIndex][lang];
  updateLangFlags();
}

function today(){
  const d=new Date();
  // Always use local timezone consistently
  d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  return d.toISOString().slice(0,10);
}

function getWeekStart(dateStr){
  const d=new Date(dateStr+'T00:00:00'); // Force local time interpretation
  const day=(d.getDay()+6)%7; // Monday = 0
  const diff=d.getDate()-day;
  const monday=new Date(d);
  monday.setDate(diff);
  monday.setHours(0,0,0,0);
  monday.setMinutes(monday.getMinutes()-monday.getTimezoneOffset());
  return monday.toISOString().slice(0,10);
}

function getWeekDays(weekStart){
  const days=[];
  const start=new Date(weekStart+'T00:00:00'); // Force local time interpretation
  for(let i=0;i<7;i++){
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    d.setHours(0,0,0,0);
    d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
    days.push(d.toISOString().slice(0,10));
  }
  return days;
}

function hasWeekDone(h,weekStart){
  const weekDays=getWeekDays(weekStart);
  return weekDays.some(day=>h.datesDone.includes(day));
}

function hasWeekFreeze(h,weekStart){
  if(!h.freezeDates) return false;
  const weekDays=getWeekDays(weekStart);
  return weekDays.some(day=>h.freezeDates.includes(day));
}

function checkAndResetStreak(h){
  if(!h.datesDone || h.datesDone.length===0) return;
  
  const todayDate=today();
  const sortedDates=h.datesDone.slice().sort();
  const lastDone=sortedDates[sortedDates.length-1];
  
  // Initialize freezeDates if it doesn't exist
  if(!h.freezeDates) h.freezeDates=[];
  
  // Calculate days between last done and today
  const daysDiff=Math.floor((new Date(todayDate)-new Date(lastDone))/DAY);
  
  // Check if we need to reset (2 days missed without freeze)
  if(daysDiff>=2){
    // Check if yesterday was frozen
    const yesterday=new Date();
    yesterday.setDate(yesterday.getDate()-1);
    yesterday.setMinutes(yesterday.getMinutes()-yesterday.getTimezoneOffset());
    const yesterdayStr=yesterday.toISOString().slice(0,10);
    
    // Check if day before yesterday was frozen
    const dayBefore=new Date();
    dayBefore.setDate(dayBefore.getDate()-2);
    dayBefore.setMinutes(dayBefore.getMinutes()-dayBefore.getTimezoneOffset());
    const dayBeforeStr=dayBefore.toISOString().slice(0,10);
    
    const yesterdayFrozen=h.freezeDates.includes(yesterdayStr);
    const dayBeforeFrozen=h.freezeDates.includes(dayBeforeStr);
    
    // If both days are not frozen, reset
    if(!yesterdayFrozen && !dayBeforeFrozen){
      h.streak=0;
    }
  }
}

function recalculateStreak(h){
  if(!h.datesDone || h.datesDone.length===0){
    h.streak=0;
    return;
  }
  
  if(!h.freezeDates) h.freezeDates=[];
  
  const todayDate=today();
  const sortedDates=h.datesDone.slice().sort().reverse(); // newest first
  
  let streak=0;
  let currentDate=new Date(todayDate);
  
  if(h.frequency==='weekly'){
    // Weekly streak calculation
    let currentWeekStart=getWeekStart(todayDate);
    
    // Check if current week is done or frozen
    const currentWeekDone=hasWeekDone(h,currentWeekStart);
    const currentWeekFrozen=hasWeekFreeze(h,currentWeekStart);
    
    if(!currentWeekDone && !currentWeekFrozen){
      h.streak=0;
      return;
    }
    
    // Count consecutive weeks
    while(true){
      const weekDone=hasWeekDone(h,currentWeekStart);
      const weekFrozen=hasWeekFreeze(h,currentWeekStart);
      
      if(weekDone){
        streak++;
      }else if(weekFrozen){
        // Frozen week counts as continuation but doesn't increment
      }else{
        break;
      }
      
      // Move to previous week
      const prevWeekDate=new Date(currentWeekStart);
      prevWeekDate.setDate(prevWeekDate.getDate()-7);
      currentWeekStart=getWeekStart(prevWeekDate.toISOString().slice(0,10));
    }
  }else{
    // Daily streak calculation
    const lastDone=sortedDates[0];
    const daysSinceLastDone=Math.floor((new Date(todayDate)-new Date(lastDone))/DAY);
    
    // Check if today is done or frozen
    const todayDone=h.datesDone.includes(todayDate);
    const todayFrozen=h.freezeDates.includes(todayDate);
    
    if(!todayDone && !todayFrozen){
      h.streak=0;
      return;
    }
    
    // Count consecutive days backwards from today
    for(let i=0;i<100;i++){ // max 100 days to prevent infinite loop
      const checkDate=new Date(todayDate);
      checkDate.setDate(checkDate.getDate()-i);
      checkDate.setMinutes(checkDate.getMinutes()-checkDate.getTimezoneOffset());
      const checkDateStr=checkDate.toISOString().slice(0,10);
      
      const isDone=h.datesDone.includes(checkDateStr);
      const isFrozen=h.freezeDates.includes(checkDateStr);
      
      if(isDone){
        streak++;
      }else if(isFrozen){
        // Frozen day - continue checking but don't increment
        continue;
      }else{
        // Gap found - stop counting
        break;
      }
    }
  }
  
  h.streak=streak;
  
  // Update best streak if current is higher
  if(!h.bestStreak || h.streak>h.bestStreak){
    h.bestStreak=h.streak;
  }
}

function startCountdown(){
  const el=document.getElementById("countdown");
  setInterval(()=>{
    const now=new Date();
    const midnight=new Date();
    midnight.setHours(24,0,0,0);
    const diff=midnight-now;
    const h=String(Math.floor(diff/3600000)).padStart(2,"0");
    const m=String(Math.floor(diff%3600000/60000)).padStart(2,"0");
    const s=String(Math.floor(diff%60000/1000)).padStart(2,"0");
    el.textContent=`${h}:${m}:${s}`;
  },1000);
}
startCountdown();

let habits=JSON.parse(localStorage.getItem("keepy"))||[];
let folders=JSON.parse(localStorage.getItem("keepyFolders"))||[];
const save=()=>{
  localStorage.setItem("keepy",JSON.stringify(habits));
  localStorage.setItem("keepyFolders",JSON.stringify(folders));
};

// Check all habits for streak resets on load
habits.forEach(h=>checkAndResetStreak(h));
save();

document.getElementById("themeBtn").onclick=()=>{
  currentTheme=(currentTheme+1)%themes.length;
  document.body.setAttribute('data-theme',themes[currentTheme]);
  document.getElementById("themeBtn").textContent=themes[currentTheme]==='light'?'‚òÄÔ∏è':themes[currentTheme]==='ocean'?'üåä':'üåô';
  localStorage.setItem("theme",themes[currentTheme]);
};

const savedTheme=localStorage.getItem("theme");
if(savedTheme){
  currentTheme=themes.indexOf(savedTheme);
  document.body.setAttribute('data-theme',savedTheme);
  document.getElementById("themeBtn").textContent=savedTheme==='light'?'‚òÄÔ∏è':savedTheme==='ocean'?'üåä':'üåô';
}

function updateStats(){
  let total=0,max=0,bestEver=0,dates={},categoryCount={},totalFreezes=0;
  
  // Today's stats - count habits done today (excluding frozen)
  const todayDate=today();
  let todayDone=0;
  let todayTotal=0;
  
  habits.forEach(h=>{
    if(!h.bestStreak) h.bestStreak=0;
    if(!h.freezeDates) h.freezeDates=[];
    
    h.datesDone.forEach(d=>{
      total++;dates[d]=(dates[d]||0)+1;
    });
    if(h.streak>max)max=h.streak;
    if(h.bestStreak>bestEver)bestEver=h.bestStreak;
    totalFreezes+=h.freezeDates.length;
    
    const cat=h.category||'other';
    if(!categoryCount[cat])categoryCount[cat]={count:0,days:0};
    categoryCount[cat].count++;
    categoryCount[cat].days+=h.datesDone.length;
    
    // Count for today's stats (exclude frozen habits)
    const isFrozenToday=h.freezeDates.includes(todayDate);
    if(!isFrozenToday){
      todayTotal++;
      if(h.datesDone.includes(todayDate)){
        todayDone++;
      }
    }
  });
  
  // Update today's stats
  const todayStatsEl=document.getElementById('todayStats');
  if(todayStatsEl){
    todayStatsEl.textContent=`${todayDone}/${todayTotal}`;
    // Color based on completion
    if(todayDone===todayTotal && todayTotal>0){
      todayStatsEl.style.color='var(--success)';
    }else if(todayDone>0){
      todayStatsEl.style.color='var(--warning)';
    }else{
      todayStatsEl.style.color='var(--accent)';
    }
  }
  
  const days=Object.keys(dates).length||1;
  totalDone.textContent=total;
  maxStreak.textContent=max;
  avgDaily.textContent=(total/days).toFixed(2);
  document.getElementById('bestEver').textContent=bestEver;
  document.getElementById('totalFreezes').textContent=totalFreezes;
  
  const categoryStats=document.getElementById("categoryStats");
  window.categoryData=categoryCount;
  
  if(Object.keys(categoryCount).length>0){
    categoryStats.style.display='block';
    renderCategoryStats();
  }
  
  const heatMap=document.getElementById("heatMap");
  heatMap.innerHTML="";
  for(let i=27;i>=0;i--){
    const d=new Date();
    d.setDate(d.getDate()-i);
    const ds=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const count=dates[ds]||0;
    const div=document.createElement("div");
    div.className="heat-day";
    if(count>0)div.classList.add(`level-${Math.min(count,4)}`);
    
    const dayNum=d.getDate();
    div.textContent=dayNum;
    
    const monthName=d.toLocaleString("pl-PL",{month:'short'});
    div.title=`${dayNum} ${monthName}: ${count} pass${count===1?'a':count>=2&&count<=4?'y':''}`;
    
    heatMap.append(div);
  }
}

function renderCategoryStats(){
  const categoryStatsList=document.getElementById("categoryStatsList");
  if(!window.categoryData) return;
  
  let entries=Object.entries(window.categoryData);
  entries.sort((a,b)=>b[1].days-a[1].days);
  
  categoryStatsList.innerHTML='';
  
  entries.forEach(([cat,data])=>{
    const div=document.createElement("div");
    div.className="category-stat-item";
    div.innerHTML=`
      <span>${getCategoryLabel(cat)}</span>
      <span style="color:var(--accent);font-weight:bold">${data.days} dni (${data.count} pass${data.count===1?'a':''})</span>
    `;
    categoryStatsList.append(div);
  });
}

function renderCalendar(h, habitIndex){
  const cont=document.createElement("div");
  cont.className="calendar-container";

  const cal=document.createElement("div");
  cal.className="calendar";
  if(h.calendarOpen) cal.classList.add("show");
  if(h.editing) cal.classList.add("editing");

  const ref=new Date();
  ref.setMonth(ref.getMonth()+h.monthOffset);
  
  const nav=document.createElement("div");
  nav.className="calendar-nav";
  const l=document.createElement("button");
  l.textContent="‚óÄ";
  const r=document.createElement("button");
  r.textContent="‚ñ∂";
  const title=document.createElement("span");
  title.textContent=ref.toLocaleString("pl-PL",{month:"long",year:"numeric"});

  nav.append(l,title,r);
  cal.append(nav);

  l.onclick=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    h.monthOffset--;
    save();
    updateSingleCalendar(habitIndex);
  }
  
  r.onclick=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    h.monthOffset++;
    save();
    updateSingleCalendar(habitIndex);
  }

  // Add weekday headers - P(on), W(t), ≈ö(r), C(z), P(t), S(o), N(d)
  const weekdaysContainer=document.createElement("div");
  weekdaysContainer.className="calendar-weekdays";
  const weekdayNames=['Pn','Wt','≈ör','Cz','Pt','So','Nd'];
  weekdayNames.forEach(name=>{
    const day=document.createElement("div");
    day.className="calendar-weekday";
    day.textContent=name;
    weekdaysContainer.append(day);
  });
  cal.append(weekdaysContainer);

  const daysContainer=document.createElement("div");
  daysContainer.className="calendar-days";

  // Fix: Use local date interpretation to avoid timezone shifts
  const first=(new Date(ref.getFullYear(),ref.getMonth(),1).getDay()+6)%7;
  const daysInMonth=new Date(ref.getFullYear(),ref.getMonth()+1,0).getDate();

  // Add empty cells for days before month starts
  for(let i=0;i<first;i++){
    const emptyDiv=document.createElement("div");
    emptyDiv.className="day";
    emptyDiv.style.opacity="0";
    emptyDiv.style.pointerEvents="none";
    daysContainer.append(emptyDiv);
  }
  
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(ref.getFullYear(),ref.getMonth(),d);
    // Use local date format to avoid timezone issues
    const year=date.getFullYear();
    const month=String(date.getMonth()+1).padStart(2,'0');
    const day=String(date.getDate()).padStart(2,'0');
    const ds=`${year}-${month}-${day}`;
    const diff=(new Date(today())-new Date(ds+'T00:00:00'))/DAY;
    const isWeekly=h.frequency==='weekly';
    
    // For weekly: allow editing current week and past 2 weeks (up to 21 days back)
    // For daily: allow editing last 14 days (increased for better mobile UX)
    let editable;
    if(isWeekly){
      const weekStart=getWeekStart(ds);
      const currentWeekStart=getWeekStart(today());
      const weekDiff=(new Date(currentWeekStart)-new Date(weekStart))/DAY/7;
      editable=(weekDiff<=2 && diff<=21);
    }else{
      editable=(diff>=0 && diff<=14);
    }
    const isToday=ds===today();

    const div=document.createElement("div");
    div.className="day";
    div.textContent=d;
    
    if(isToday) div.classList.add("today");

    if(!h.freezeDates) h.freezeDates=[];

    if(isWeekly){
      const weekStart=getWeekStart(ds);
      const isDoneThisWeek=hasWeekDone(h,weekStart);
      const isFrozenThisWeek=hasWeekFreeze(h,weekStart);
      const isPastWeek=diff>7;
      
      if(h.freeze && weekStart===getWeekStart(today())){
        // Current week with active freeze
        div.classList.add("week-freeze");
      }else if(isFrozenThisWeek){
        // Past week that was frozen
        div.classList.add("week-freeze");
      }else if(isDoneThisWeek){
        div.classList.add("week-done");
      }else if(isPastWeek){
        div.classList.add("week-missed");
      }
    }else{
      const wasFrozen=h.freezeDates.includes(ds);
      const isDone=h.datesDone.includes(ds);
      
      if(h.freeze && ds===today()){
        // Today with active freeze
        div.classList.add("freeze");
      }else if(wasFrozen){
        // Past day that was frozen
        div.classList.add("freeze");
      }else if(isDone){
        div.classList.add("done");
      }else if(diff>0){
        div.classList.add("missed");
      }
    }
    
    if(!editable) div.classList.add("locked");

    div.onclick=(e)=>{
      e.preventDefault();
      e.stopPropagation();
      if(!h.editing || !editable) return;
      
      if(isWeekly){
        const weekStart=getWeekStart(ds);
        const weekDays=getWeekDays(weekStart);
        const isDoneThisWeek=hasWeekDone(h,weekStart);
        const isFrozenThisWeek=hasWeekFreeze(h,weekStart);
        
        // Toggle between done, frozen, and empty
        if(isDoneThisWeek){
          // If done, make it frozen
          weekDays.forEach(day=>{
            h.datesDone=h.datesDone.filter(x=>x!==day);
            if(!h.freezeDates.includes(day)){
              h.freezeDates.push(day);
            }
          });
        }else if(isFrozenThisWeek){
          // If frozen, clear it
          weekDays.forEach(day=>{
            h.freezeDates=h.freezeDates.filter(x=>x!==day);
          });
        }else{
          // If empty, make it done
          if(!h.datesDone.includes(ds)){
            h.datesDone.push(ds);
          }
        }
      }else{
        const isDone=h.datesDone.includes(ds);
        const isFrozen=h.freezeDates.includes(ds);
        
        // Toggle between done, frozen, and empty
        if(isDone){
          // If done, make it frozen
          h.datesDone=h.datesDone.filter(x=>x!==ds);
          if(!h.freezeDates.includes(ds)){
            h.freezeDates.push(ds);
          }
        }else if(isFrozen){
          // If frozen, clear it
          h.freezeDates=h.freezeDates.filter(x=>x!==ds);
        }else{
          // If empty, make it done
          h.datesDone.push(ds);
        }
      }
      
      // Check if we cleared today - reset freeze flag if so
      const todayDate=today();
      if(ds===todayDate || (isWeekly && getWeekStart(ds)===getWeekStart(todayDate))){
        const todayDone=h.datesDone.includes(todayDate);
        const todayFrozen=h.freezeDates.includes(todayDate);
        
        // If today is now empty (not done and not frozen), reset the freeze flag
        if(!todayDone && !todayFrozen){
          h.freeze=false;
        }
      }
      
      // Recalculate streak after editing
      recalculateStreak(h);
      
      save();
      
      // Check if we need to update the buttons (if editing today)
      if(ds===todayDate || (isWeekly && getWeekStart(ds)===getWeekStart(todayDate))){
        // Find the parent habit element and recreate it to reset buttons
        const habitDiv=e.target.closest('.habit');
        if(habitDiv){
          const habitParent=habitDiv.parentElement;
          const newDiv=createHabitElement(h,habitIndex);
          habitParent.replaceChild(newDiv,habitDiv);
          setTimeout(()=>newDiv.classList.add("show"),10);
        }
      }else{
        // Just update the calendar
        updateSingleCalendar(habitIndex);
      }
      
      updateStats();
      
      // Update the streak display with animation
      const streakEl=document.getElementById(`streak-${habitIndex}`);
      if(streakEl){
        const streakEmoji=h.streakEmoji||'üî•';
        const numberEl=streakEl.querySelector('.streak-number');
        if(numberEl){
          numberEl.classList.add('bump');
          numberEl.textContent=`${streakEmoji} ${h.streak}`;
          setTimeout(()=>numberEl.classList.remove('bump'),600);
        }else{
          streakEl.innerHTML=`<span class="streak-number">${streakEmoji} ${h.streak}</span>`;
        }
      }
    };

    daysContainer.append(div);
  }

  cal.append(daysContainer);
  cont.append(cal);
  return {cont,cal};
}

function updateSingleCalendar(habitIndex){
  const h=habits[habitIndex];
  if(!h) return;
  
  // Find the habit element - could be in folders or main list
  let habitDiv=null;
  
  // Check in folders first
  const folderDivs=document.querySelectorAll('.folder-content .habit');
  folderDivs.forEach(div=>{
    const streakDiv=div.querySelector(`#streak-${habitIndex}`);
    if(streakDiv) habitDiv=div;
  });
  
  // If not found in folders, check main list
  if(!habitDiv){
    const mainDivs=list.querySelectorAll('.habit');
    mainDivs.forEach(div=>{
      const streakDiv=div.querySelector(`#streak-${habitIndex}`);
      if(streakDiv) habitDiv=div;
    });
  }
  
  if(!habitDiv) return;
  
  const calendarContainer=habitDiv.querySelector('.calendar-container');
  if(!calendarContainer) return;
  
  const {cont}=renderCalendar(h, habitIndex);
  calendarContainer.innerHTML='';
  calendarContainer.append(cont.firstChild);
}

function getCategoryLabel(category){
  const defaultLabels={
    sport:'üèÉ Sport',
    health:'üíö Zdrowie',
    work:'üíº Praca',
    study:'üìö Nauka',
    hobby:'üé® Hobby',
    other:'‚ö™ Inne'
  };
  return defaultLabels[category]||`‚≠ê ${category}`;
}

function getCategoryColor(category){
  const defaultColors={
    sport:'#3b82f6',
    health:'#22c55e',
    work:'#f59e0b',
    study:'#8b5cf6',
    hobby:'#ec4899',
    other:'#6b7280'
  };
  return defaultColors[category]||'#10b981';
}

function moveHabit(fromIndex, toIndex){
  if(fromIndex===toIndex) return;
  const temp=habits[fromIndex];
  habits.splice(fromIndex,1);
  habits.splice(toIndex,0,temp);
  save();
  render();
}

function renderFolders(){
  foldersContainer.innerHTML='';
  
  folders.forEach((folder,folderIndex)=>{
    const folderHabits=habits.filter(h=>h.folderId===folder.id);
    
    const folderDiv=document.createElement("div");
    folderDiv.className="folder";
    
    const header=document.createElement("div");
    header.className="folder-header";
    
    header.innerHTML=`
      <div class="folder-title">
        <span>${folder.emoji||'üìÅ'}</span>
        <span>${folder.name}</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="folder-count">${folderHabits.length}</span>
        <button class="more" style="background:var(--bg-tertiary);color:var(--text-primary);font-size:18px;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;min-width:38px;min-height:38px;transition:transform .2s, opacity .2s">‚ãØ</button>
        <span style="font-size:18px;transition:transform .2s" id="folderArrow-${folderIndex}">‚ñº</span>
      </div>
    `;
    
    // Menu for folder
    const menu=document.createElement("div");
    menu.className="menu";
    menu.style.display="none";
    menu.innerHTML=`
      <button class="editFolder">‚úèÔ∏è Edytuj folder</button>
      <button class="deleteFolder danger">üóë Usu≈Ñ folder</button>
    `;
    
    folderDiv.append(menu);
    
    const moreBtn=header.querySelector('.more');
    moreBtn.onclick=(e)=>{
      e.stopPropagation();
      document.querySelectorAll('.menu').forEach(m=>m.style.display='none');
      document.querySelectorAll('.folder').forEach(f=>f.classList.remove('menu-open'));
      document.querySelectorAll('.habit').forEach(h=>h.classList.remove('menu-open'));
      menu.style.display=menu.style.display==="block"?"none":"block";
      if(menu.style.display==="block"){
        folderDiv.classList.add('menu-open');
      }
    };
    
    menu.querySelector('.editFolder').onclick=()=>{
      menu.style.display="none";
      folderDiv.classList.remove('menu-open');
      
      const editFolderModal=document.getElementById("editFolderModal");
      editFolderModal.classList.add("show");
      editFolderModal.dataset.folderIndex=folderIndex;
      document.getElementById("editFolderName").value=folder.name;
      document.getElementById("editFolderEmoji").value=folder.emoji||'';
    };
    
    menu.querySelector('.deleteFolder').onclick=()=>{
      menu.style.display="none";
      folderDiv.classList.remove('menu-open');
      
      const deleteFolderModal=document.getElementById("deleteFolderModal");
      document.getElementById("deleteFolderName").textContent=folder.name;
      deleteFolderModal.classList.add("show");
      deleteFolderModal.dataset.folderIndex=folderIndex;
    };
    
    // Toggle folder content on header click (but not on more button)
    const titleArea=header.querySelector('.folder-title');
    const arrowArea=header.querySelector(`#folderArrow-${folderIndex}`);
    
    const toggleFolder=()=>{
      folder.open=!folder.open;
      save();
      renderFolders();
    };
    
    titleArea.onclick=toggleFolder;
    arrowArea.onclick=toggleFolder;
    
    const content=document.createElement("div");
    content.className="folder-content";
    if(folder.open) content.classList.add('show');
    
    folderHabits.forEach((h,i)=>{
      const actualIndex=habits.indexOf(h);
      const habitDiv=createHabitElement(h,actualIndex);
      content.append(habitDiv);
      setTimeout(()=>habitDiv.classList.add("show"),10+i*50);
    });
    
    folderDiv.append(header,content);
    foldersContainer.append(folderDiv);
    
    const arrow=document.getElementById(`folderArrow-${folderIndex}`);
    if(arrow) arrow.style.transform=folder.open?'rotate(180deg)':'rotate(0deg)';
  });
}

function createHabitElement(h,i){
  const div=document.createElement("div");
  div.className="habit";
  if(h.editing) div.classList.add('editing-mode');
  if(movingHabitIndex===i) div.classList.add('move-mode');
  
  div.style.borderLeftColor=getCategoryColor(h.category||'other');
  
  const streakEmoji=h.streakEmoji||'üî•';
  const isDoneToday=h.datesDone.includes(today());
  const isFrozenToday=h.freezeDates && h.freezeDates.includes(today());
  const frequency=h.frequency||'daily';
  const frequencyLabel=frequency==='weekly'?'üìÜ Tyg.':'üìÖ Codz.';
  
  // Determine button states and classes
  let doneClasses='done';
  let freezeClasses='freeze';
  let freezeText='‚ùÑÔ∏è Freeze';
  let doneStyle='';
  let freezeStyle='';
  
  if(isDoneToday){
    doneClasses='done completed';
    doneStyle='opacity:0.7;pointer-events:none;';
    freezeStyle='opacity:0.7;pointer-events:none;';
  }else if(isFrozenToday){
    doneClasses='done';
    freezeClasses='freeze active';
    freezeText='‚ùÑÔ∏è Aktywny';
    doneStyle='opacity:0.7;pointer-events:none;';
    freezeStyle='opacity:0.7;pointer-events:none;';
  }

  div.innerHTML=`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <span class="category-badge cat-${h.category||'other'}">${getCategoryLabel(h.category||'other')}</span>
      <span class="frequency-badge">${frequencyLabel}</span>
    </div>
    <div class="habit-header">
      <div class="habit-info">
        <div class="name">${h.name}</div>
        <div class="streak" id="streak-${i}"><span class="streak-number">${streakEmoji} ${h.streak}</span></div>
      </div>
      <div class="actions">
        <button class="${doneClasses}" style="${doneStyle}">${isDoneToday?'':''}‚úì Zrobione</button>
        <button class="${freezeClasses}" style="${freezeStyle}">${freezeText}</button>
        <button class="more">‚ãØ</button>
      </div>
    </div>
    <div class="menu">
      <button class="moveHabit">‚ÜïÔ∏è Przenie≈õ passƒô</button>
      <button class="editHist">‚úèÔ∏è Edytuj historiƒô</button>
      <button class="customizeHabit">‚öôÔ∏è Zmie≈Ñ... ‚ñ∂</button>
      <button class="moveToFolder">üìÅ Przenie≈õ do folderu</button>
      <button class="deleteHist danger">üóë Usu≈Ñ passƒô</button>
    </div>
    <div class="submenu">
      <button class="renameHabit">‚úçÔ∏è Zmie≈Ñ nazwƒô</button>
      <button class="changeCat">üè∑Ô∏è Zmie≈Ñ kategoriƒô</button>
      <button class="changeFreq">üìÜ Zmie≈Ñ czƒôstotliwo≈õƒá</button>
      <button class="changeEmoji">üî• Zmie≈Ñ emoji</button>
    </div>
    <div class="move-buttons" id="moveButtons-${i}">
      <button class="moveUp" ${i===0?'disabled':''}>‚¨ÜÔ∏è W g√≥rƒô</button>
      <button class="moveDown" ${i===habits.length-1?'disabled':''}>‚¨áÔ∏è W d√≥≈Ç</button>
      <button class="moveCancel">‚úñÔ∏è Anuluj</button>
    </div>
  `;

  const menu=div.querySelector(".menu");
  const submenu=div.querySelector(".submenu");
  const moreBtn=div.querySelector(".more");
  const moveButtons=div.querySelector(".move-buttons");
  
  moreBtn.onclick=(e)=>{
    e.stopPropagation();
    document.querySelectorAll('.menu').forEach(m=>m.style.display='none');
    document.querySelectorAll('.submenu').forEach(m=>m.style.display='none');
    document.querySelectorAll('.habit').forEach(h=>h.classList.remove('menu-open'));
    menu.style.display=menu.style.display==="block"?"none":"block";
    if(menu.style.display==="block"){
      div.classList.add('menu-open');
    }
  };
  
  div.querySelector(".customizeHabit").onclick=(e)=>{
    e.stopPropagation();
    menu.style.display="none";
    submenu.style.display="block";
  };

  const toggle=document.createElement("button");
  toggle.className="toggle-cal";
  toggle.textContent=h.calendarOpen?"üìÖ Ukryj kalendarz":"üìÖ Poka≈º kalendarz";

  const {cont}=renderCalendar(h, i);

  toggle.onclick=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    h.calendarOpen=!h.calendarOpen;
    save();
    const calendarDiv=div.querySelector('.calendar');
    if(h.calendarOpen){
      calendarDiv.classList.add('show');
      toggle.textContent="üìÖ Ukryj kalendarz";
    }else{
      calendarDiv.classList.remove('show');
      toggle.textContent="üìÖ Poka≈º kalendarz";
    }
  };

  div.querySelector(".moveHabit").onclick=()=>{
    menu.style.display="none";
    div.classList.remove('menu-open');
    movingHabitIndex=i;
    div.classList.add('move-mode');
    moveButtons.classList.add('show');
  };

  div.querySelector(".moveUp").onclick=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    if(i>0){
      moveHabit(i,i-1);
      movingHabitIndex=null;
    }
  };

  div.querySelector(".moveDown").onclick=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    if(i<habits.length-1){
      moveHabit(i,i+1);
      movingHabitIndex=null;
    }
  };

  div.querySelector(".moveCancel").onclick=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    movingHabitIndex=null;
    div.classList.remove('move-mode');
    moveButtons.classList.remove('show');
  };

  div.querySelector(".editHist").onclick=()=>{
    h.editing=!h.editing;
    menu.style.display="none";
    div.classList.remove('menu-open');
    
    if(h.editing){
      if(!h.calendarOpen) h.calendarOpen=true;
      div.classList.add('editing-mode');
      
      // Just update the calendar to show/apply editing mode
      const calendarDiv=div.querySelector('.calendar');
      if(calendarDiv){
        calendarDiv.classList.add('show','editing');
        const toggleBtn=div.querySelector('.toggle-cal');
        if(toggleBtn) toggleBtn.textContent="üìÖ Ukryj kalendarz";
      }
    }else{
      div.classList.remove('editing-mode');
      const calendarDiv=div.querySelector('.calendar');
      if(calendarDiv) calendarDiv.classList.remove('editing');
    }
    save();
  };

  div.querySelector(".renameHabit").onclick=()=>{
    menu.style.display="none";
    submenu.style.display="none";
    div.classList.remove('menu-open');
    const newName=prompt("Nowa nazwa passy:",h.name);
    if(newName && newName.trim()){
      h.name=newName.trim();
      save();
      // Update name in DOM
      const nameEl=div.querySelector('.name');
      if(nameEl) nameEl.textContent=h.name;
    }
  };

  div.querySelector(".changeCat").onclick=()=>{
    menu.style.display="none";
    submenu.style.display="none";
    const editCatModal=document.getElementById("editCategoryModal");
    editCatModal.classList.add("show");
    editCatModal.dataset.habitIndex=i;
    document.getElementById("editCategorySelect").value=h.category||'other';
  };

  div.querySelector(".changeEmoji").onclick=()=>{
    menu.style.display="none";
    submenu.style.display="none";
    const emojiModal=document.getElementById("streakEmojiModal");
    emojiModal.classList.add("show");
    emojiModal.dataset.habitIndex=i;
    document.getElementById("streakEmoji").value=h.streakEmoji||'';
  };
  
  div.querySelector(".changeFreq").onclick=()=>{
    menu.style.display="none";
    submenu.style.display="none";
    div.classList.remove('menu-open');
    const current=h.frequency||'daily';
    const newFreq=current==='daily'?'weekly':'daily';
    const label=newFreq==='weekly'?'tygodniowo':'codziennie';
    if(confirm(`Zmieniƒá czƒôstotliwo≈õƒá na: ${label}?`)){
      h.frequency=newFreq;
      
      // Recalculate streak for new frequency
      recalculateStreak(h);
      
      save();
      
      // Recreate the habit element to show new frequency
      const habitParent=div.parentElement;
      const newDiv=createHabitElement(h,i);
      habitParent.replaceChild(newDiv,div);
      setTimeout(()=>newDiv.classList.add("show"),10);
      
      updateStats();
    }
  };
  
  div.querySelector(".moveToFolder").onclick=()=>{
    menu.style.display="none";
    if(folders.length===0){
      alert("Najpierw utw√≥rz folder!");
      return;
    }
    
    const folderOptions=folders.map((f,idx)=>`${idx+1}. ${f.emoji||'üìÅ'} ${f.name}`).join('\n');
    const choice=prompt(`Wybierz folder (wpisz numer):\n0. Bez folderu\n${folderOptions}`);
    
    if(choice!==null){
      const num=parseInt(choice);
      if(num===0){
        delete h.folderId;
      }else if(num>0 && num<=folders.length){
        h.folderId=folders[num-1].id;
      }
      save();
      render();
    }
  };

  div.querySelector(".deleteHist").onclick=(e)=>{
    e.stopPropagation();
    menu.style.display="none";
    div.classList.remove('menu-open');
    
    // Show delete confirmation modal
    const deleteModal=document.getElementById("deleteConfirmModal");
    const deleteHabitName=document.getElementById("deleteHabitName");
    const deleteHabitStreak=document.getElementById("deleteHabitStreak");
    
    deleteHabitName.textContent=h.name;
    deleteHabitStreak.textContent=`${h.streakEmoji||'üî•'}${h.streak}`;
    
    deleteModal.classList.add("show");
    deleteModal.dataset.habitIndex=i;
  };

  div.querySelector(".done").onclick=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    
    // Check if already done or frozen
    if(isDoneToday || isFrozenToday) return;
    
    if(!h.datesDone.includes(today())){
      h.datesDone.push(today());
      h.streak++;
      if(!h.bestStreak || h.streak>h.bestStreak) h.bestStreak=h.streak;
      save();
      
      // Force update the entire habit element to reflect changes
      const habitParent=div.parentElement;
      const newDiv=createHabitElement(h,i);
      habitParent.replaceChild(newDiv,div);
      setTimeout(()=>newDiv.classList.add("show"),10);
      
      updateStats();
      
      // Animate streak after a brief delay
      setTimeout(()=>{
        const streakEl=document.getElementById(`streak-${i}`);
        if(streakEl){
          const numberEl=streakEl.querySelector('.streak-number');
          if(numberEl){
            numberEl.style.animation='none';
            setTimeout(()=>{
              numberEl.style.animation='slideDown .4s ease-out';
            },10);
          }
        }
      },100);
    }
  };

  div.querySelector(".freeze").onclick=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    
    // Check if already done or frozen
    if(isDoneToday || isFrozenToday){
      if(isFrozenToday){
        showToast("Freeze jest aktywny na dzisiaj i nie mo≈ºna go cofnƒÖƒá");
      }
      return;
    }
    
    // Activating freeze
    h.freeze=true;
    if(!h.freezeDates) h.freezeDates=[];
    if(!h.freezeDates.includes(today())){
      h.freezeDates.push(today());
    }
    
    save();
    
    // Show ice animation - longer duration to match CSS
    div.classList.add("ice");
    setTimeout(()=>div.classList.remove("ice"),1200);
    
    // Force update the entire habit element to reflect changes
    const habitParent=div.parentElement;
    const newDiv=createHabitElement(h,i);
    habitParent.replaceChild(newDiv,div);
    setTimeout(()=>newDiv.classList.add("show"),10);
    
    updateStats();
  };

  div.append(toggle,cont,moveButtons);
  return div;
}

function render(){
  const emptyState=document.getElementById("emptyState");
  const categoryStats=document.getElementById("categoryStats");
  
  if(habits.length===0 && folders.length===0){
    list.innerHTML="";
    foldersContainer.innerHTML="";
    emptyState.style.display='block';
    categoryStats.style.display='none';
    updateStats();
    return;
  }
  
  emptyState.style.display='none';
  
  renderFolders();
  
  list.innerHTML='<div class="loading-skeleton"></div><div class="loading-skeleton"></div>';
  
  setTimeout(()=>{
    list.innerHTML="";
    const habitsWithoutFolder=habits.filter(h=>!h.folderId);
    
    habitsWithoutFolder.forEach((h,localIndex)=>{
      const i=habits.indexOf(h);
      const div=createHabitElement(h,i);
      list.append(div);
      setTimeout(()=>div.classList.add("show"),10+localIndex*50);
    });
    updateStats();
  },100);
}

const modal=document.getElementById("addModal");

document.getElementById("addTypeHabit").onclick=()=>{
  addingType='habit';
  document.getElementById("addTypeHabit").style.background='var(--accent)';
  document.getElementById("addTypeHabit").style.borderColor='var(--accent)';
  document.getElementById("addTypeHabit").style.color='white';
  document.getElementById("addTypeFolder").style.background='var(--bg-tertiary)';
  document.getElementById("addTypeFolder").style.borderColor='var(--bg-tertiary)';
  document.getElementById("addTypeFolder").style.color='var(--text-primary)';
  document.getElementById("habitFields").style.display='block';
  document.getElementById("folderFields").style.display='none';
  document.getElementById("addModalTitle").textContent='‚ûï Dodaj nowƒÖ passƒô';
};

document.getElementById("addTypeFolder").onclick=()=>{
  addingType='folder';
  document.getElementById("addTypeFolder").style.background='var(--accent)';
  document.getElementById("addTypeFolder").style.borderColor='var(--accent)';
  document.getElementById("addTypeFolder").style.color='white';
  document.getElementById("addTypeHabit").style.background='var(--bg-tertiary)';
  document.getElementById("addTypeHabit").style.borderColor='var(--bg-tertiary)';
  document.getElementById("addTypeHabit").style.color='var(--text-primary)';
  document.getElementById("habitFields").style.display='none';
  document.getElementById("folderFields").style.display='block';
  document.getElementById("addModalTitle").textContent='üìÅ Dodaj nowy folder';
};

document.getElementById("addBtn").onclick=()=>{
  modal.classList.add("show");
  addingType='habit';
  document.getElementById("addTypeHabit").click();
  document.getElementById("habitName").value="";
  document.getElementById("habitCategory").value="sport";
  document.getElementById("customCategory").style.display="none";
  document.getElementById("folderName").value="";
  document.getElementById("folderEmoji").value="";
  
  const folderSelect=document.getElementById("habitFolder");
  folderSelect.innerHTML='<option value="">Bez folderu</option>';
  folders.forEach(f=>{
    const opt=document.createElement("option");
    opt.value=f.id;
    opt.textContent=`${f.emoji||'üìÅ'} ${f.name}`;
    folderSelect.append(opt);
  });
};

document.getElementById("habitCategory").onchange=(e)=>{
  const customInput=document.getElementById("customCategory");
  customInput.style.display=e.target.value==='custom'?'block':'none';
  if(e.target.value==='custom') customInput.focus();
};

document.getElementById("cancelBtn").onclick=()=>{
  modal.classList.remove("show");
};

document.getElementById("saveBtn").onclick=()=>{
  if(addingType==='habit'){
    const n=document.getElementById("habitName").value.trim();
    let c=document.getElementById("habitCategory").value;
    const folderId=document.getElementById("habitFolder").value;
    const frequency=document.getElementById("habitFrequency").value;
    
    if(c==='custom'){
      const custom=document.getElementById("customCategory").value.trim();
      if(!custom) return alert("Wpisz nazwƒô kategorii");
      c=custom;
    }
    if(n){
      const newHabit={
        name:n,
        category:c,
        frequency:frequency,
        streak:0,
        bestStreak:0,
        datesDone:[],
        freezeDates:[],
        freeze:false,
        monthOffset:0,
        calendarOpen:false,
        editing:false
      };
      if(folderId) newHabit.folderId=folderId;
      
      habits.push(newHabit);
      save();
      render();
      modal.classList.remove("show");
    }
  }else{
    const n=document.getElementById("folderName").value.trim();
    const emoji=document.getElementById("folderEmoji").value.trim();
    
    if(n){
      folders.push({
        id:Date.now().toString(),
        name:n,
        emoji:emoji||'üìÅ',
        open:true
      });
      save();
      render();
      modal.classList.remove("show");
    }
  }
};

modal.onclick=(e)=>{
  if(e.target===modal) modal.classList.remove("show");
};

const editCatModal=document.getElementById("editCategoryModal");

document.getElementById("editCategorySelect").onchange=(e)=>{
  const customInput=document.getElementById("editCustomCategory");
  customInput.style.display=e.target.value==='custom'?'block':'none';
  if(e.target.value==='custom') customInput.focus();
};

document.getElementById("cancelEditCatBtn").onclick=()=>{
  editCatModal.classList.remove("show");
};

document.getElementById("saveEditCatBtn").onclick=()=>{
  const idx=parseInt(editCatModal.dataset.habitIndex);
  let c=document.getElementById("editCategorySelect").value;
  if(c==='custom'){
    const custom=document.getElementById("editCustomCategory").value.trim();
    if(!custom) return alert("Wpisz nazwƒô kategorii");
    c=custom;
  }
  habits[idx].category=c;
  save();
  editCatModal.classList.remove("show");
  
  // Recreate only the affected habit element
  const h=habits[idx];
  
  // Find the habit div
  let habitDiv=null;
  const allHabits=document.querySelectorAll('.habit');
  allHabits.forEach(div=>{
    const streakEl=div.querySelector(`#streak-${idx}`);
    if(streakEl) habitDiv=div;
  });
  
  if(habitDiv){
    const habitParent=habitDiv.parentElement;
    const newDiv=createHabitElement(h,idx);
    habitParent.replaceChild(newDiv,habitDiv);
    setTimeout(()=>newDiv.classList.add("show"),10);
  }
};

editCatModal.onclick=(e)=>{
  if(e.target===editCatModal) editCatModal.classList.remove("show");
};

const streakEmojiModal=document.getElementById("streakEmojiModal");

document.getElementById("cancelStreakEmojiBtn").onclick=()=>{
  streakEmojiModal.classList.remove("show");
};

document.getElementById("saveStreakEmojiBtn").onclick=()=>{
  const idx=parseInt(streakEmojiModal.dataset.habitIndex);
  const emoji=document.getElementById("streakEmoji").value.trim();
  habits[idx].streakEmoji=emoji||'üî•';
  save();
  streakEmojiModal.classList.remove("show");
  
  // Update streak display
  const streakEl=document.getElementById(`streak-${idx}`);
  if(streakEl){
    const h=habits[idx];
    const streakEmoji=h.streakEmoji||'üî•';
    streakEl.innerHTML=`<span class="streak-number">${streakEmoji} ${h.streak}</span>`;
  }
};

streakEmojiModal.onclick=(e)=>{
  if(e.target===streakEmojiModal) streakEmojiModal.classList.remove("show");
};

document.querySelectorAll('.lang-flag').forEach(btn=>{
  btn.onclick=(e)=>{
    e.stopPropagation();
    switchQuoteLang(btn.dataset.lang);
  };
});

const savedLang=localStorage.getItem('quoteLang');
if(savedLang) currentQuoteLang=savedLang;

document.getElementById("categoryStatsToggle").onclick=()=>{
  const list=document.getElementById("categoryStatsList");
  const toggle=document.getElementById("categoryStatsToggle");
  if(list.style.display==='none'){
    list.style.display='block';
    toggle.innerHTML='üìà Statystyki per kategoria <span style="float:right">‚ñ≤</span>';
  }else{
    list.style.display='none';
    toggle.innerHTML='üìà Statystyki per kategoria <span style="float:right">‚ñº</span>';
  }
};

document.getElementById("heatMapToggle").onclick=()=>{
  const container=document.getElementById("heatMapContainer");
  const toggle=document.getElementById("heatMapToggle");
  if(container.style.display==='none'){
    container.style.display='block';
    toggle.innerHTML='üìä Aktywno≈õƒá (ostatnie 28 dni) <span style="float:right">‚ñ≤</span>';
  }else{
    container.style.display='none';
    toggle.innerHTML='üìä Aktywno≈õƒá (ostatnie 28 dni) <span style="float:right">‚ñº</span>';
  }
};

const settingsBtn=document.createElement("button");
settingsBtn.className="theme-toggle";
settingsBtn.style.left="0";
settingsBtn.style.right="auto";
settingsBtn.textContent="üí≠";
settingsBtn.onclick=()=>{
  const quotesModal=document.getElementById("manageQuotesModal");
  quotesModal.classList.add("show");
  const customQuotes=JSON.parse(localStorage.getItem("customQuotes")||"[]");
  document.getElementById("customQuotes").value=customQuotes.join("\n");
  const savedLang=localStorage.getItem("quoteLanguage")||"pl";
  document.getElementById("quoteLanguage").value=savedLang;
};
document.querySelector(".header").append(settingsBtn);

const quotesModal=document.getElementById("manageQuotesModal");

document.getElementById("cancelQuotesBtn").onclick=()=>{
  quotesModal.classList.remove("show");
};

document.getElementById("saveQuotesBtn").onclick=()=>{
  const text=document.getElementById("customQuotes").value;
  const quotes=text.split("\n").map(q=>q.trim()).filter(q=>q);
  const language=document.getElementById("quoteLanguage").value;
  localStorage.setItem("customQuotes",JSON.stringify(quotes));
  localStorage.setItem("quoteLanguage",language);
  quotesModal.classList.remove("show");
  updateQuote();
  showToast("Cytaty zapisane! üíæ");
};

quotesModal.onclick=(e)=>{
  if(e.target===quotesModal) quotesModal.classList.remove("show");
};

// Delete confirmation modal handlers
const deleteConfirmModal=document.getElementById("deleteConfirmModal");

document.getElementById("cancelDeleteBtn").onclick=()=>{
  deleteConfirmModal.classList.remove("show");
};

document.getElementById("confirmDeleteBtn").onclick=()=>{
  const idx=parseInt(deleteConfirmModal.dataset.habitIndex);
  deletedHabit={...habits[idx]};
  deletedIndex=idx;
  habits.splice(idx,1);
  save();
  render();
  deleteConfirmModal.classList.remove("show");
  showToast("Passa usuniƒôta","Cofnij",()=>{
    habits.splice(deletedIndex,0,deletedHabit);
    save();
    render();
  });
};

deleteConfirmModal.onclick=(e)=>{
  if(e.target===deleteConfirmModal) deleteConfirmModal.classList.remove("show");
};

// Delete folder confirmation modal handlers
const deleteFolderModal=document.getElementById("deleteFolderModal");

document.getElementById("cancelDeleteFolderBtn").onclick=()=>{
  deleteFolderModal.classList.remove("show");
};

document.getElementById("confirmDeleteFolderBtn").onclick=()=>{
  const idx=parseInt(deleteFolderModal.dataset.folderIndex);
  const folder=folders[idx];
  
  // Move all habits from folder to main list
  habits.forEach(h=>{
    if(h.folderId===folder.id) delete h.folderId;
  });
  
  folders.splice(idx,1);
  save();
  render();
  deleteFolderModal.classList.remove("show");
  showToast(`Folder "${folder.name}" usuniƒôty`);
};

deleteFolderModal.onclick=(e)=>{
  if(e.target===deleteFolderModal) deleteFolderModal.classList.remove("show");
};

// Edit folder modal handlers
const editFolderModal=document.getElementById("editFolderModal");

document.getElementById("cancelEditFolderBtn").onclick=()=>{
  editFolderModal.classList.remove("show");
};

document.getElementById("saveEditFolderBtn").onclick=()=>{
  const idx=parseInt(editFolderModal.dataset.folderIndex);
  const newName=document.getElementById("editFolderName").value.trim();
  const newEmoji=document.getElementById("editFolderEmoji").value.trim();
  
  if(newName){
    folders[idx].name=newName;
    folders[idx].emoji=newEmoji||'üìÅ';
    save();
    renderFolders();
    editFolderModal.classList.remove("show");
  }else{
    alert("Wpisz nazwƒô folderu");
  }
};

editFolderModal.onclick=(e)=>{
  if(e.target===editFolderModal) editFolderModal.classList.remove("show");
};

// Search functionality
const searchInput=document.getElementById("searchInput");
let searchTimeout;

// Add focus/blur styling
searchInput.onfocus=()=>{
  searchInput.style.borderColor='var(--accent)';
  searchInput.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)';
};
searchInput.onblur=()=>{
  searchInput.style.borderColor='var(--bg-tertiary)';
  searchInput.style.boxShadow='none';
};

searchInput.oninput=(e)=>{
  clearTimeout(searchTimeout);
  searchTimeout=setTimeout(()=>{
    const query=e.target.value.toLowerCase().trim();
    
    // Get all habit elements
    const allHabits=document.querySelectorAll('.habit');
    const allFolders=document.querySelectorAll('.folder');
    
    if(!query){
      // Show all
      allHabits.forEach(h=>h.style.display='block');
      allFolders.forEach(f=>f.style.display='block');
      return;
    }
    
    // Filter habits
    allHabits.forEach(habitDiv=>{
      const nameEl=habitDiv.querySelector('.name');
      if(nameEl){
        const name=nameEl.textContent.toLowerCase();
        if(name.includes(query)){
          habitDiv.style.display='block';
        }else{
          habitDiv.style.display='none';
        }
      }
    });
    
    // Show/hide folders based on if they have visible habits
    allFolders.forEach(folderDiv=>{
      const visibleHabits=folderDiv.querySelectorAll('.habit[style*="display: block"], .habit:not([style*="display: none"])');
      if(visibleHabits.length>0 || !query){
        folderDiv.style.display='block';
      }else{
        folderDiv.style.display='none';
      }
    });
  },300);
};

updateQuote();

document.addEventListener('click',(e)=>{
  if(!e.target.closest('.menu') && !e.target.closest('.submenu') && !e.target.closest('.more')){
    document.querySelectorAll('.menu').forEach(m=>m.style.display='none');
    document.querySelectorAll('.submenu').forEach(m=>m.style.display='none');
    document.querySelectorAll('.habit').forEach(h=>h.classList.remove('menu-open'));
    document.querySelectorAll('.folder').forEach(f=>f.classList.remove('menu-open'));
  }
});

render();
</script>
</body>
</html>
